{% extends "dashboard_base.html" %}
{% block title %}Find Jobs â€” LevelUpX{% endblock %}
{% block page_title %}Jobs{% endblock %}
{% block content %}

<div class="max-w-5xl mx-auto anim-fade-up">

    <!-- Header -->
    <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3 mb-6">
        <div>
            <h1 class="text-2xl font-bold text-slate-800">Find Jobs</h1>
            <p class="text-sm text-slate-500 mt-1">Search public job listings and see how your resume matches</p>
        </div>
    </div>

    <!-- Primary Resume Indicator -->
    {% if primary_resume %}
    <div class="bg-white rounded-xl border border-slate-200 p-3 mb-6 flex items-center gap-3 text-sm shadow-sm">
        <div class="w-8 h-8 bg-brand-50 rounded-lg flex items-center justify-center flex-shrink-0">
            <svg class="w-4 h-4 text-brand-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>
        </div>
        <span class="text-slate-600">Matching against: <strong class="text-slate-800">{{ primary_resume.label or primary_resume.filename }}</strong></span>
        <span class="ml-auto text-xs text-slate-400 hidden sm:inline">ATS scores auto-calculated</span>
    </div>
    {% else %}
    <div class="bg-amber-50 border border-amber-200 rounded-xl p-4 mb-6 text-center">
        <p class="text-sm text-amber-700 mb-1">Upload and set a primary resume to see ATS match scores</p>
        <a href="{{ url_for('analyze_page') }}" class="text-sm text-brand-600 font-semibold hover:underline">Go to Resumes &rarr;</a>
    </div>
    {% endif %}

    <!-- Search / Filter Form -->
    <div class="bg-white rounded-2xl shadow-lg border border-slate-200 p-5 mb-6">
        <form id="jobSearchForm" onsubmit="searchJobs(event)" class="space-y-4">
            <!-- Row 1: Keyword + Location -->
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                <div>
                    <label class="block text-xs font-medium text-slate-600 mb-1.5">Job Title / Keywords</label>
                    <input type="text" name="q" id="search-query" placeholder="e.g. Python Developer, Product Manager"
                        class="w-full border border-slate-200 rounded-xl px-4 py-2.5 text-sm focus:ring-2 focus:ring-brand-500 focus:border-brand-500 outline-none transition" required>
                </div>
                <div>
                    <label class="block text-xs font-medium text-slate-600 mb-1.5">Location</label>
                    <input type="text" name="location" id="search-location" placeholder="e.g. Bangalore, Remote, USA"
                        class="w-full border border-slate-200 rounded-xl px-4 py-2.5 text-sm focus:ring-2 focus:ring-brand-500 focus:border-brand-500 outline-none transition">
                </div>
            </div>
            <!-- Row 2: Job Type + Experience -->
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                <div>
                    <label class="block text-xs font-medium text-slate-600 mb-1.5">Job Type</label>
                    <select name="type" id="search-type" class="w-full border border-slate-200 rounded-xl px-4 py-2.5 text-sm focus:ring-2 focus:ring-brand-500 outline-none transition bg-white">
                        <option value="">All Types</option>
                        <option value="FULLTIME">Full-time</option>
                        <option value="PARTTIME">Part-time</option>
                        <option value="CONTRACTOR">Contract</option>
                        <option value="INTERN">Internship</option>
                    </select>
                </div>
                <div>
                    <label class="block text-xs font-medium text-slate-600 mb-1.5">Experience Level</label>
                    <select name="experience" id="search-experience" class="w-full border border-slate-200 rounded-xl px-4 py-2.5 text-sm focus:ring-2 focus:ring-brand-500 outline-none transition bg-white">
                        <option value="">Any Level</option>
                        <option value="no_experience">Entry Level / No Experience</option>
                        <option value="under_3_years">Under 3 Years</option>
                        <option value="more_than_3_years">3+ Years</option>
                        <option value="no_degree">No Degree Required</option>
                    </select>
                </div>
            </div>
            <!-- Search Button -->
            <div class="flex items-center gap-3">
                <button type="submit" id="searchBtn"
                    class="inline-flex items-center gap-2 bg-gradient-to-r from-brand-600 to-emerald-500 hover:from-brand-700 hover:to-emerald-600 text-white font-semibold py-2.5 px-8 rounded-xl shadow-lg transition text-sm disabled:opacity-50 disabled:cursor-not-allowed">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/></svg>
                    Search Jobs
                </button>
                <span id="result-count" class="text-xs text-slate-400 hidden"></span>
            </div>
        </form>
    </div>

    <!-- Results Area -->
    <div id="results-area">
        <!-- Empty state (shown initially) -->
        <div id="empty-state" class="bg-white rounded-2xl shadow-lg border border-slate-100 p-12 text-center">
            <div class="w-20 h-20 bg-brand-50 rounded-2xl flex items-center justify-center mx-auto mb-6">
                <svg class="w-10 h-10 text-brand-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M21 13.255A23.931 23.931 0 0112 15c-3.183 0-6.22-.62-9-1.745M16 6V4a2 2 0 00-2-2h-4a2 2 0 00-2 2v2m4 6h.01M5 20h14a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/></svg>
            </div>
            <h3 class="text-xl font-bold text-slate-900 mb-2">Search for Jobs</h3>
            <p class="text-slate-500 max-w-sm mx-auto text-sm">Enter a job title or keywords above to find matching positions. We'll show you how well your resume matches each listing.</p>
        </div>

        <!-- Loading state -->
        <div id="loading-state" class="hidden text-center py-16">
            <div class="relative w-16 h-16 mx-auto mb-4">
                <div class="absolute inset-0 rounded-full border-4 border-slate-200"></div>
                <div class="absolute inset-0 rounded-full border-4 border-transparent border-t-brand-500 border-r-emerald-500 animate-spin"></div>
                <div class="absolute inset-0 flex items-center justify-center">
                    <svg class="w-6 h-6 text-brand-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/></svg>
                </div>
            </div>
            <p class="text-sm text-slate-500 font-medium">Searching jobs & calculating match scores...</p>
            <p class="text-xs text-slate-400 mt-1">This may take a few seconds</p>
        </div>

        <!-- Error state -->
        <div id="error-state" class="hidden bg-red-50 border border-red-200 rounded-2xl p-8 text-center">
            <svg class="w-10 h-10 text-red-400 mx-auto mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L4.082 16.5c-.77.833.192 2.5 1.732 2.5z"/></svg>
            <h3 class="text-base font-bold text-red-800 mb-1">Search Error</h3>
            <p id="error-message" class="text-sm text-red-600"></p>
        </div>

        <!-- No results state -->
        <div id="no-results" class="hidden bg-white rounded-2xl shadow-lg border border-slate-100 p-12 text-center">
            <svg class="w-12 h-12 text-slate-300 mx-auto mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9.172 16.172a4 4 0 015.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
            <h3 class="text-lg font-bold text-slate-700 mb-1">No Jobs Found</h3>
            <p class="text-sm text-slate-500">Try broadening your search terms or changing your filters.</p>
        </div>

        <!-- Results grid (populated by JS) -->
        <div id="jobs-grid" class="hidden space-y-4"></div>
    </div>

</div>

<script>
let currentCredits = {{ credits_remaining }};

async function searchJobs(e) {
    e.preventDefault();

    const query = document.getElementById('search-query').value.trim();
    const location = document.getElementById('search-location').value.trim();
    const type = document.getElementById('search-type').value;
    const experience = document.getElementById('search-experience').value;

    if (!query) return;

    // Show loading
    document.getElementById('empty-state').classList.add('hidden');
    document.getElementById('no-results').classList.add('hidden');
    document.getElementById('jobs-grid').classList.add('hidden');
    document.getElementById('error-state').classList.add('hidden');
    document.getElementById('loading-state').classList.remove('hidden');
    document.getElementById('result-count').classList.add('hidden');
    document.getElementById('searchBtn').disabled = true;

    const params = new URLSearchParams({ q: query, location, type, experience });
    try {
        const resp = await fetch('/jobs/search?' + params);
        const data = await resp.json();
        document.getElementById('loading-state').classList.add('hidden');
        document.getElementById('searchBtn').disabled = false;

        if (data.error) {
            document.getElementById('error-message').textContent = data.error;
            document.getElementById('error-state').classList.remove('hidden');
            return;
        }

        if (!data.jobs || data.jobs.length === 0) {
            document.getElementById('no-results').classList.remove('hidden');
            return;
        }

        document.getElementById('result-count').textContent = data.jobs.length + ' job' + (data.jobs.length !== 1 ? 's' : '') + ' found';
        document.getElementById('result-count').classList.remove('hidden');
        renderJobs(data.jobs);
    } catch (err) {
        document.getElementById('loading-state').classList.add('hidden');
        document.getElementById('searchBtn').disabled = false;
        document.getElementById('error-message').textContent = 'Network error. Please try again.';
        document.getElementById('error-state').classList.remove('hidden');
    }
}

function renderJobs(jobs) {
    const grid = document.getElementById('jobs-grid');
    grid.innerHTML = '';

    jobs.forEach((job, idx) => {
        const card = document.createElement('div');
        card.className = 'bg-white rounded-2xl shadow-sm border border-slate-200 p-5 hover:shadow-md transition';
        card.id = 'job-card-' + idx;

        // ATS score badge
        let scoreBadge = '';
        if (job.ats_score !== null && job.ats_score !== undefined) {
            const s = job.ats_score;
            let sc, sl;
            if (s >= 85) { sc = 'bg-emerald-100 text-emerald-700'; sl = 'Great Match'; }
            else if (s >= 70) { sc = 'bg-blue-100 text-blue-700'; sl = 'Good Match'; }
            else if (s >= 50) { sc = 'bg-amber-100 text-amber-700'; sl = 'Fair Match'; }
            else if (s >= 30) { sc = 'bg-orange-100 text-orange-700'; sl = 'Low Match'; }
            else { sc = 'bg-red-100 text-red-700'; sl = 'Weak Match'; }
            scoreBadge = `
                <div class="text-center flex-shrink-0">
                    <span class="inline-flex items-center justify-center w-11 h-7 rounded-lg font-bold text-sm ${sc}">${s}</span>
                    <span class="block mt-0.5 text-[9px] font-bold px-1.5 py-0.5 rounded-full ${sc}">${sl}</span>
                </div>`;
        }

        // Tags
        let tags = '';
        if (job.employment_type) tags += `<span class="text-[10px] font-medium px-2 py-0.5 rounded-full bg-slate-100 text-slate-600">${job.employment_type}</span>`;
        if (job.is_remote) tags += '<span class="text-[10px] font-medium px-2 py-0.5 rounded-full bg-emerald-50 text-emerald-600">Remote</span>';
        if (job.salary_min) tags += `<span class="text-[10px] font-medium px-2 py-0.5 rounded-full bg-blue-50 text-blue-600">${formatSalary(job)}</span>`;
        if (job.posted_date) tags += `<span class="text-[10px] font-medium px-2 py-0.5 rounded-full bg-slate-50 text-slate-500">${job.posted_date}</span>`;

        // Company logo
        const logo = job.company_logo
            ? `<img src="${escHtml(job.company_logo)}" class="w-full h-full object-contain rounded-lg" onerror="this.parentElement.innerHTML='<span class=\\'text-lg font-bold text-slate-400\\'>${escHtml((job.company || '?')[0])}</span>'">`
            : `<span class="text-lg font-bold text-slate-400">${escHtml((job.company || '?')[0])}</span>`;

        card.innerHTML = `
            <div class="flex items-start gap-4">
                <div class="w-12 h-12 bg-slate-100 rounded-xl flex items-center justify-center flex-shrink-0 overflow-hidden">
                    ${logo}
                </div>
                <div class="flex-1 min-w-0">
                    <h3 class="text-sm font-bold text-slate-800 leading-snug">${escHtml(job.title)}</h3>
                    <p class="text-xs text-slate-500 mt-0.5">${escHtml(job.company)}${job.location ? ' &middot; ' + escHtml(job.location) : ''}</p>
                    <div class="flex flex-wrap gap-1.5 mt-2">${tags}</div>
                    <p class="text-xs text-slate-400 mt-2 line-clamp-2">${escHtml(job.description_snippet || '')}</p>
                    <div class="flex items-center gap-2 mt-3">
                        ${job.apply_url ? `<a href="${escHtml(job.apply_url)}" target="_blank" rel="noopener" class="inline-flex items-center gap-1.5 text-xs font-semibold text-white bg-brand-600 hover:bg-brand-700 px-4 py-1.5 rounded-lg transition">Apply <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"/></svg></a>` : ''}
                        <button onclick="deepAnalyze(${idx}, this)" data-job-idx="${idx}"
                            class="deep-analyze-btn inline-flex items-center gap-1.5 text-xs font-semibold text-brand-600 bg-brand-50 hover:bg-brand-100 px-3 py-1.5 rounded-lg transition">
                            <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/></svg>
                            Deep Analyze (3 credits)
                        </button>
                    </div>
                </div>
                <div class="hidden sm:block">${scoreBadge}</div>
            </div>
            <!-- Mobile score -->
            ${scoreBadge ? `<div class="sm:hidden flex justify-end mt-3 pt-3 border-t border-slate-100">${scoreBadge}</div>` : ''}
        `;
        grid.appendChild(card);
    });

    grid.classList.remove('hidden');

    // Store jobs data globally for deep analyze
    window._jobResults = jobs;
}

async function deepAnalyze(idx, btn) {
    const job = window._jobResults[idx];
    if (!job) return;

    if (currentCredits < 3) {
        alert('You need 3 credits for deep analysis. You have ' + currentCredits + '. Buy more credits first.');
        return;
    }

    // Confirm
    if (!confirm('Deep ATS analysis costs 3 credits. You have ' + currentCredits + ' credits. Proceed?')) return;

    // Show loading on button
    const origHTML = btn.innerHTML;
    btn.disabled = true;
    btn.innerHTML = '<svg class="w-3 h-3 animate-spin" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"/><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"/></svg> Analyzing...';

    try {
        const resp = await fetch('/jobs/deep-analyze', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                job_id: job.job_id,
                description: job.description,
            }),
        });

        const data = await resp.json();

        if (data.error) {
            alert(data.error);
            btn.disabled = false;
            btn.innerHTML = origHTML;
            return;
        }

        // Update credits
        if (data.credits_remaining !== undefined) {
            currentCredits = data.credits_remaining;
        }

        // Update the score badge on the card
        const card = document.getElementById('job-card-' + idx);
        if (card && data.ats_score !== undefined) {
            const s = data.ats_score;
            let sc, sl;
            if (s >= 85) { sc = 'bg-emerald-100 text-emerald-700'; sl = 'Great Match'; }
            else if (s >= 70) { sc = 'bg-blue-100 text-blue-700'; sl = 'Good Match'; }
            else if (s >= 50) { sc = 'bg-amber-100 text-amber-700'; sl = 'Fair Match'; }
            else if (s >= 30) { sc = 'bg-orange-100 text-orange-700'; sl = 'Low Match'; }
            else { sc = 'bg-red-100 text-red-700'; sl = 'Weak Match'; }

            const newBadge = `<div class="text-center flex-shrink-0">
                <span class="inline-flex items-center justify-center w-11 h-7 rounded-lg font-bold text-sm ${sc}">${s}</span>
                <span class="block mt-0.5 text-[9px] font-bold px-1.5 py-0.5 rounded-full ${sc}">${sl}</span>
                <span class="block mt-0.5 text-[8px] text-slate-400">AI Score</span>
            </div>`;

            // Update desktop score
            const desktopScore = card.querySelector('.hidden.sm\\:block');
            if (desktopScore) desktopScore.innerHTML = newBadge;

            // Update mobile score
            const mobileScore = card.querySelector('.sm\\:hidden.flex.justify-end');
            if (mobileScore) mobileScore.innerHTML = newBadge;
        }

        // Replace button with success message
        btn.className = 'inline-flex items-center gap-1.5 text-xs font-semibold text-emerald-600 bg-emerald-50 px-3 py-1.5 rounded-lg';
        btn.innerHTML = '<svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/></svg> Deep Score: ' + data.ats_score;
        btn.disabled = true;

    } catch (err) {
        alert('Network error. Please try again.');
        btn.disabled = false;
        btn.innerHTML = origHTML;
    }
}

function formatSalary(job) {
    if (!job.salary_min) return '';
    const curr = job.salary_currency || '$';
    const period = job.salary_period || 'year';
    if (job.salary_max) return curr + Number(job.salary_min).toLocaleString() + '-' + curr + Number(job.salary_max).toLocaleString() + '/' + period;
    return curr + Number(job.salary_min).toLocaleString() + '/' + period;
}

function escHtml(str) {
    if (!str) return '';
    const div = document.createElement('div');
    div.textContent = str;
    return div.innerHTML;
}
</script>

{% endblock %}
