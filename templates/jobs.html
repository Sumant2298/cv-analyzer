{% extends "dashboard_base.html" %}
{% block title %}Jobs — LevelUpX{% endblock %}
{% block page_title %}Jobs{% endblock %}
{% block content %}

<div class="max-w-5xl mx-auto anim-fade-up">

    <!-- Header -->
    <div class="mb-6">
        <h1 class="text-2xl font-bold text-slate-800">Jobs</h1>
        <p class="text-sm text-slate-500 mt-1">Search public job listings and see how your resume matches</p>
    </div>

    <!-- Primary Resume Indicator -->
    {% if primary_resume %}
    <div class="bg-white rounded-xl border border-slate-200 p-3 mb-6 flex items-center gap-3 text-sm shadow-sm">
        <div class="w-8 h-8 bg-brand-50 rounded-lg flex items-center justify-center flex-shrink-0">
            <svg class="w-4 h-4 text-brand-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>
        </div>
        <span class="text-slate-600">Matching against: <strong class="text-slate-800">{{ primary_resume.label or primary_resume.filename }}</strong></span>
        <span class="ml-auto text-xs text-slate-400 hidden sm:inline">ATS scores auto-calculated</span>
    </div>
    {% else %}
    <div class="bg-amber-50 border border-amber-200 rounded-xl p-4 mb-6 text-center">
        <p class="text-sm text-amber-700 mb-1">Upload and set a primary resume to see ATS match scores</p>
        <a href="{{ url_for('resume_studio_library') }}" class="text-sm text-brand-600 font-semibold hover:underline">Go to My Resumes &rarr;</a>
    </div>
    {% endif %}

    <!-- Preferences Summary Bar (return visits only) -->
    <div id="prefs-summary" class="hidden bg-white rounded-xl border border-slate-200 p-3 mb-6 shadow-sm">
        <div class="flex items-center gap-2">
            <svg class="w-4 h-4 text-slate-400 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z"/></svg>
            <span id="prefs-summary-text" class="text-xs text-slate-600 flex-1 min-w-0"></span>
            <button onclick="openEditPrefs()" id="editPrefsBtn"
                class="inline-flex items-center gap-1.5 text-xs font-medium text-brand-600 hover:text-brand-700 bg-brand-50 hover:bg-brand-100 px-3 py-1.5 rounded-lg transition flex-shrink-0">
                <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4"/></svg>
                Edit Filters
            </button>
        </div>
    </div>

    <!-- ===== WIZARD MODAL (first visit) ===== -->
    {% if show_wizard %}
    <div id="wizard-overlay" class="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4" style="backdrop-filter:blur(4px)">
        <div class="bg-white rounded-2xl shadow-2xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
            <!-- Wizard Header -->
            <div class="p-6 pb-4 border-b border-slate-100">
                <h2 class="text-xl font-bold text-slate-800">Set Up Your Job Preferences</h2>
                <p class="text-sm text-slate-500 mt-1">Tell us what you're looking for. We'll save these and find matching jobs for you.</p>
                <!-- Step indicators -->
                <div class="flex gap-2 mt-4">
                    <div id="step-dot-1" class="h-1.5 flex-1 rounded-full bg-brand-500 transition-colors"></div>
                    <div id="step-dot-2" class="h-1.5 flex-1 rounded-full bg-slate-200 transition-colors"></div>
                    <div id="step-dot-3" class="h-1.5 flex-1 rounded-full bg-slate-200 transition-colors"></div>
                </div>
            </div>

            <div class="p-6">
                <!-- Step 1: What You Do (Function → Role Family → Level cascade) -->
                <div id="wiz-step-1" class="wiz-step">
                    <h3 class="text-base font-bold text-slate-800 mb-4 flex items-center gap-2">
                        <span class="w-6 h-6 rounded-full bg-brand-100 text-brand-700 text-xs font-bold flex items-center justify-center">1</span>
                        What You Do
                    </h3>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-xs font-medium text-slate-600 mb-1.5">Function</label>
                            <select id="wiz-job-function" onchange="onFunctionChange('wiz')" class="w-full border border-slate-200 rounded-xl px-4 py-2.5 text-sm focus:ring-2 focus:ring-brand-500 outline-none bg-white">
                                <option value="">Select a function...</option>
                            </select>
                        </div>
                        <div id="wiz-role-section" class="hidden">
                            <label class="block text-xs font-medium text-slate-600 mb-1.5">Role Family</label>
                            <select id="wiz-job-role" onchange="onRoleFamilyChange('wiz')" class="w-full border border-slate-200 rounded-xl px-4 py-2.5 text-sm focus:ring-2 focus:ring-brand-500 outline-none bg-white disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                                <option value="">Select a role family...</option>
                            </select>
                        </div>
                        <div id="wiz-level-section" class="hidden">
                            <label class="block text-xs font-medium text-slate-600 mb-1.5">Level</label>
                            <select id="wiz-job-level" onchange="onLevelChange('wiz')" class="w-full border border-slate-200 rounded-xl px-4 py-2.5 text-sm focus:ring-2 focus:ring-brand-500 outline-none bg-white disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                                <option value="">Select a level...</option>
                            </select>
                        </div>
                        <div id="wiz-titles-section" class="hidden">
                            <label class="block text-xs font-medium text-slate-600 mb-1.5">Job Title Suggestions <span class="text-slate-400 font-normal">(click to toggle selection)</span></label>
                            <div class="flex items-center gap-2 mb-2">
                                <button type="button" id="wiz-suggest-titles-btn" onclick="fetchTitleSuggestions('wiz')" disabled
                                    class="inline-flex items-center gap-1.5 text-xs font-medium text-brand-600 bg-brand-50 hover:bg-brand-100 px-3 py-1.5 rounded-lg border border-brand-200 transition disabled:opacity-50 disabled:cursor-not-allowed">
                                    <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/></svg>
                                    Get Title Suggestions
                                </button>
                                <span id="wiz-titles-loading" class="hidden text-xs text-slate-400">
                                    <svg class="w-3.5 h-3.5 animate-spin inline mr-1" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"/><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"/></svg>
                                    Generating...
                                </span>
                                <span id="wiz-titles-error" class="hidden text-xs text-red-500"></span>
                            </div>
                            <div id="wiz-job-titles-pills" class="flex flex-wrap gap-2"></div>
                        </div>
                    </div>
                </div>

                <!-- Step 2: Work Preferences -->
                <div id="wiz-step-2" class="wiz-step hidden">
                    <h3 class="text-base font-bold text-slate-800 mb-4 flex items-center gap-2">
                        <span class="w-6 h-6 rounded-full bg-brand-100 text-brand-700 text-xs font-bold flex items-center justify-center">2</span>
                        Work Preferences
                    </h3>
                    <div class="space-y-4">
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-xs font-medium text-slate-600 mb-1.5">Experience Level</label>
                                <select id="wiz-experience" class="w-full border border-slate-200 rounded-xl px-4 py-2.5 text-sm focus:ring-2 focus:ring-brand-500 outline-none bg-white">
                                    <option value="any">Any Level</option>
                                    <option value="fresher">Fresher</option>
                                    <option value="0_3_years">0-3 Years</option>
                                    <option value="3_8_years">3-8 Years</option>
                                    <option value="8_15_years">8-15 Years</option>
                                    <option value="15_plus_years">15+ Years</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-xs font-medium text-slate-600 mb-1.5">Work Mode</label>
                                <div id="wiz-work-mode" class="flex flex-wrap gap-2">
                                    <button type="button" onclick="togglePill(this,'wiz-work-mode')" data-value="any" class="pill-btn active text-xs px-3 py-1.5 rounded-full border transition">Any</button>
                                    <button type="button" onclick="togglePill(this,'wiz-work-mode')" data-value="remote" class="pill-btn text-xs px-3 py-1.5 rounded-full border transition">Remote</button>
                                    <button type="button" onclick="togglePill(this,'wiz-work-mode')" data-value="hybrid" class="pill-btn text-xs px-3 py-1.5 rounded-full border transition">Hybrid</button>
                                    <button type="button" onclick="togglePill(this,'wiz-work-mode')" data-value="onsite" class="pill-btn text-xs px-3 py-1.5 rounded-full border transition">On-site</button>
                                </div>
                            </div>
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-slate-600 mb-1.5">Employment Type</label>
                            <div id="wiz-emp-types" class="flex flex-wrap gap-2">
                                <button type="button" onclick="toggleMultiPill(this)" data-value="FULLTIME" class="mpill-btn text-xs px-3 py-1.5 rounded-full border transition">Full-time</button>
                                <button type="button" onclick="toggleMultiPill(this)" data-value="PARTTIME" class="mpill-btn text-xs px-3 py-1.5 rounded-full border transition">Part-time</button>
                                <button type="button" onclick="toggleMultiPill(this)" data-value="CONTRACTOR" class="mpill-btn text-xs px-3 py-1.5 rounded-full border transition">Contract</button>
                                <button type="button" onclick="toggleMultiPill(this)" data-value="INTERN" class="mpill-btn text-xs px-3 py-1.5 rounded-full border transition">Internship</button>
                            </div>
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-slate-600 mb-1.5">Preferred Locations</label>
                            <div id="wiz-locations-selected" class="flex flex-wrap gap-1.5 mb-2"></div>
                            <div id="wiz-locations-grid" class="flex flex-wrap gap-1.5"></div>
                        </div>
                    </div>
                </div>

                <!-- Step 3: Expected Salary Range -->
                <div id="wiz-step-3" class="wiz-step hidden">
                    <h3 class="text-base font-bold text-slate-800 mb-4 flex items-center gap-2">
                        <span class="w-6 h-6 rounded-full bg-brand-100 text-brand-700 text-xs font-bold flex items-center justify-center">3</span>
                        Expected Salary Range
                    </h3>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-xs font-medium text-slate-600 mb-2">Salary Range (Quick Select)</label>
                            <div class="flex flex-wrap gap-2">
                                <button type="button" onclick="setSalaryPreset(300000,600000)" class="text-xs px-3 py-1.5 rounded-full border border-slate-200 hover:bg-brand-50 hover:border-brand-300 transition">3-6 LPA</button>
                                <button type="button" onclick="setSalaryPreset(600000,1200000)" class="text-xs px-3 py-1.5 rounded-full border border-slate-200 hover:bg-brand-50 hover:border-brand-300 transition">6-12 LPA</button>
                                <button type="button" onclick="setSalaryPreset(1200000,2500000)" class="text-xs px-3 py-1.5 rounded-full border border-slate-200 hover:bg-brand-50 hover:border-brand-300 transition">12-25 LPA</button>
                                <button type="button" onclick="setSalaryPreset(2500000,5000000)" class="text-xs px-3 py-1.5 rounded-full border border-slate-200 hover:bg-brand-50 hover:border-brand-300 transition">25-50 LPA</button>
                                <button type="button" onclick="setSalaryPreset(5000000,null)" class="text-xs px-3 py-1.5 rounded-full border border-slate-200 hover:bg-brand-50 hover:border-brand-300 transition">50+ LPA</button>
                            </div>
                        </div>
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-xs font-medium text-slate-600 mb-1.5">Minimum Salary (INR)</label>
                                <div class="relative">
                                    <span class="absolute left-3 top-1/2 -translate-y-1/2 text-sm text-slate-400">&#8377;</span>
                                    <input type="number" id="wiz-salary-min" placeholder="e.g. 600000"
                                        class="w-full border border-slate-200 rounded-xl pl-8 pr-4 py-2.5 text-sm focus:ring-2 focus:ring-brand-500 outline-none">
                                </div>
                            </div>
                            <div>
                                <label class="block text-xs font-medium text-slate-600 mb-1.5">Maximum Salary (INR)</label>
                                <div class="relative">
                                    <span class="absolute left-3 top-1/2 -translate-y-1/2 text-sm text-slate-400">&#8377;</span>
                                    <input type="number" id="wiz-salary-max" placeholder="e.g. 2500000"
                                        class="w-full border border-slate-200 rounded-xl pl-8 pr-4 py-2.5 text-sm focus:ring-2 focus:ring-brand-500 outline-none">
                                </div>
                            </div>
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-slate-600 mb-1.5">Salary Period</label>
                            <div class="flex gap-2">
                                <button type="button" onclick="togglePill(this,'wiz-salary-period')" data-value="annual" class="pill-btn active text-xs px-4 py-1.5 rounded-full border transition">Annual</button>
                                <button type="button" onclick="togglePill(this,'wiz-salary-period')" data-value="monthly" class="pill-btn text-xs px-4 py-1.5 rounded-full border transition">Monthly</button>
                            </div>
                        </div>
                        <p class="text-[10px] text-slate-400">Jobs without salary info are always shown. Leave blank to skip salary filtering.</p>
                    </div>
                </div>

            </div>

            <!-- Wizard Footer -->
            <div class="p-6 pt-4 border-t border-slate-100 flex items-center justify-between">
                <button type="button" onclick="skipWizard()" class="text-xs text-slate-400 hover:text-slate-600 transition">Skip for now</button>
                <div class="flex gap-3">
                    <button type="button" id="wiz-back-btn" onclick="wizStep(-1)" class="hidden text-sm font-medium text-slate-600 hover:text-slate-800 px-4 py-2 rounded-xl transition">Back</button>
                    <button type="button" id="wiz-next-btn" onclick="wizStep(1)"
                        class="inline-flex items-center gap-2 bg-gradient-to-r from-brand-600 to-emerald-500 hover:from-brand-700 hover:to-emerald-600 text-white font-semibold py-2.5 px-6 rounded-xl shadow-lg transition text-sm">
                        Next
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/></svg>
                    </button>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- ===== FILTER PANEL (return visits — collapsible) ===== -->
    <div id="filter-panel" class="hidden bg-white rounded-2xl shadow-lg border border-slate-200 mb-6 overflow-hidden">
        <div class="p-5 space-y-4">
            <!-- Accordion sections use same IDs but with 'fp-' prefix -->
            <!-- Section 1: Job Selection -->
            <div class="border border-slate-100 rounded-xl overflow-hidden">
                <button type="button" onclick="toggleAccordion('fp-sec-1')" class="w-full flex items-center justify-between p-3 text-sm font-semibold text-slate-700 hover:bg-slate-50 transition">
                    <span>Job Selection</span>
                    <svg class="w-4 h-4 text-slate-400 accordion-chevron transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg>
                </button>
                <div id="fp-sec-1" class="hidden p-3 pt-0 space-y-3">
                    <div>
                        <label class="block text-xs font-medium text-slate-600 mb-1">Function</label>
                        <select id="fp-job-function" onchange="onFunctionChange('fp')" class="w-full border border-slate-200 rounded-lg px-3 py-2 text-xs focus:ring-2 focus:ring-brand-500 outline-none bg-white">
                            <option value="">Select...</option>
                        </select>
                    </div>
                    <div id="fp-role-section" class="hidden">
                        <label class="block text-xs font-medium text-slate-600 mb-1">Role Family</label>
                        <select id="fp-job-role" onchange="onRoleFamilyChange('fp')" class="w-full border border-slate-200 rounded-lg px-3 py-2 text-xs focus:ring-2 focus:ring-brand-500 outline-none bg-white disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                            <option value="">Select...</option>
                        </select>
                    </div>
                    <div id="fp-level-section" class="hidden">
                        <label class="block text-xs font-medium text-slate-600 mb-1">Level</label>
                        <select id="fp-job-level" onchange="onLevelChange('fp')" class="w-full border border-slate-200 rounded-lg px-3 py-2 text-xs focus:ring-2 focus:ring-brand-500 outline-none bg-white disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                            <option value="">Select...</option>
                        </select>
                    </div>
                    <div id="fp-titles-section" class="hidden">
                        <label class="block text-xs font-medium text-slate-600 mb-1">Job Title Suggestions</label>
                        <div class="flex items-center gap-2 mb-1.5">
                            <button type="button" id="fp-suggest-titles-btn" onclick="fetchTitleSuggestions('fp')" disabled
                                class="inline-flex items-center gap-1 text-[10px] font-medium text-brand-600 bg-brand-50 hover:bg-brand-100 px-2.5 py-1 rounded-lg border border-brand-200 transition disabled:opacity-50 disabled:cursor-not-allowed">
                                <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/></svg>
                                Get Title Suggestions
                            </button>
                            <span id="fp-titles-loading" class="hidden text-[10px] text-slate-400">
                                <svg class="w-3 h-3 animate-spin inline mr-0.5" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"/><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"/></svg>
                                Generating...
                            </span>
                            <span id="fp-titles-error" class="hidden text-[10px] text-red-500"></span>
                        </div>
                        <div id="fp-job-titles-pills" class="flex flex-wrap gap-1.5"></div>
                    </div>
                </div>
            </div>
            <!-- Section 2: Work Preferences -->
            <div class="border border-slate-100 rounded-xl overflow-hidden">
                <button type="button" onclick="toggleAccordion('fp-sec-2')" class="w-full flex items-center justify-between p-3 text-sm font-semibold text-slate-700 hover:bg-slate-50 transition">
                    <span>Work Preferences</span>
                    <svg class="w-4 h-4 text-slate-400 accordion-chevron transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg>
                </button>
                <div id="fp-sec-2" class="hidden p-3 pt-0 space-y-3">
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
                        <div>
                            <label class="block text-xs font-medium text-slate-600 mb-1">Experience</label>
                            <select id="fp-experience" class="w-full border border-slate-200 rounded-lg px-3 py-2 text-xs focus:ring-2 focus:ring-brand-500 outline-none bg-white">
                                <option value="any">Any Level</option>
                                <option value="fresher">Fresher</option>
                                <option value="0_3_years">0-3 Years</option>
                                <option value="3_8_years">3-8 Years</option>
                                <option value="8_15_years">8-15 Years</option>
                                <option value="15_plus_years">15+ Years</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-slate-600 mb-1">Work Mode</label>
                            <div id="fp-work-mode" class="flex flex-wrap gap-1.5">
                                <button type="button" onclick="togglePill(this,'fp-work-mode')" data-value="any" class="pill-btn active text-[10px] px-2.5 py-1 rounded-full border transition">Any</button>
                                <button type="button" onclick="togglePill(this,'fp-work-mode')" data-value="remote" class="pill-btn text-[10px] px-2.5 py-1 rounded-full border transition">Remote</button>
                                <button type="button" onclick="togglePill(this,'fp-work-mode')" data-value="hybrid" class="pill-btn text-[10px] px-2.5 py-1 rounded-full border transition">Hybrid</button>
                                <button type="button" onclick="togglePill(this,'fp-work-mode')" data-value="onsite" class="pill-btn text-[10px] px-2.5 py-1 rounded-full border transition">On-site</button>
                            </div>
                        </div>
                    </div>
                    <div>
                        <label class="block text-xs font-medium text-slate-600 mb-1">Employment Type</label>
                        <div id="fp-emp-types" class="flex flex-wrap gap-1.5">
                            <button type="button" onclick="toggleMultiPill(this)" data-value="FULLTIME" class="mpill-btn text-[10px] px-2.5 py-1 rounded-full border transition">Full-time</button>
                            <button type="button" onclick="toggleMultiPill(this)" data-value="PARTTIME" class="mpill-btn text-[10px] px-2.5 py-1 rounded-full border transition">Part-time</button>
                            <button type="button" onclick="toggleMultiPill(this)" data-value="CONTRACTOR" class="mpill-btn text-[10px] px-2.5 py-1 rounded-full border transition">Contract</button>
                            <button type="button" onclick="toggleMultiPill(this)" data-value="INTERN" class="mpill-btn text-[10px] px-2.5 py-1 rounded-full border transition">Internship</button>
                        </div>
                    </div>
                    <div>
                        <label class="block text-xs font-medium text-slate-600 mb-1">Locations</label>
                        <div id="fp-locations-selected" class="flex flex-wrap gap-1 mb-1.5"></div>
                        <div id="fp-locations-grid" class="flex flex-wrap gap-1"></div>
                    </div>
                </div>
            </div>
            <!-- Section 3: Expected Salary Range -->
            <div class="border border-slate-100 rounded-xl overflow-hidden">
                <button type="button" onclick="toggleAccordion('fp-sec-3')" class="w-full flex items-center justify-between p-3 text-sm font-semibold text-slate-700 hover:bg-slate-50 transition">
                    <span>Expected Salary Range</span>
                    <svg class="w-4 h-4 text-slate-400 accordion-chevron transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg>
                </button>
                <div id="fp-sec-3" class="hidden p-3 pt-0 space-y-3">
                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <label class="block text-xs font-medium text-slate-600 mb-1">Min Salary (INR)</label>
                            <input type="number" id="fp-salary-min" class="w-full border border-slate-200 rounded-lg px-3 py-2 text-xs focus:ring-2 focus:ring-brand-500 outline-none" placeholder="e.g. 600000">
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-slate-600 mb-1">Max Salary (INR)</label>
                            <input type="number" id="fp-salary-max" class="w-full border border-slate-200 rounded-lg px-3 py-2 text-xs focus:ring-2 focus:ring-brand-500 outline-none" placeholder="e.g. 2500000">
                        </div>
                    </div>
                    <div>
                        <label class="block text-xs font-medium text-slate-600 mb-1">Salary Period</label>
                        <div id="fp-salary-period" class="flex flex-wrap gap-1.5">
                            <button type="button" onclick="togglePill(this,'fp-salary-period')" data-value="annual" class="pill-btn active text-[10px] px-2.5 py-1 rounded-full border transition">Annual</button>
                            <button type="button" onclick="togglePill(this,'fp-salary-period')" data-value="monthly" class="pill-btn text-[10px] px-2.5 py-1 rounded-full border transition">Monthly</button>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Update Button -->
            <div class="flex items-center gap-3 pt-2">
                <button type="button" onclick="updateAndSearch()" id="updateSearchBtn"
                    class="inline-flex items-center gap-2 bg-gradient-to-r from-brand-600 to-emerald-500 hover:from-brand-700 hover:to-emerald-600 text-white font-semibold py-2.5 px-6 rounded-xl shadow-lg transition text-sm disabled:opacity-50">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/></svg>
                    Update & Search
                </button>
                <button type="button" onclick="closeFilterPanel()" class="text-xs text-slate-400 hover:text-slate-600 transition">Cancel</button>
                <span id="result-count" class="text-xs text-slate-400 hidden ml-auto"></span>
            </div>
        </div>
    </div>

    <!-- ===== RESULTS AREA ===== -->
    <div id="results-area">
        <!-- Empty state -->
        <div id="empty-state" class="bg-white rounded-2xl shadow-lg border border-slate-100 p-12 text-center">
            <div class="w-20 h-20 bg-brand-50 rounded-2xl flex items-center justify-center mx-auto mb-6">
                <svg class="w-10 h-10 text-brand-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M21 13.255A23.931 23.931 0 0112 15c-3.183 0-6.22-.62-9-1.745M16 6V4a2 2 0 00-2-2h-4a2 2 0 00-2 2v2m4 6h.01M5 20h14a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/></svg>
            </div>
            <h3 class="text-xl font-bold text-slate-900 mb-2">Search for Jobs</h3>
            <p class="text-slate-500 max-w-sm mx-auto text-sm">Set up your preferences to find matching positions. We'll show how well your resume matches each listing.</p>
        </div>
        <!-- Loading state -->
        <div id="loading-state" class="hidden text-center py-16">
            <div class="relative w-16 h-16 mx-auto mb-4">
                <div class="absolute inset-0 rounded-full border-4 border-slate-200"></div>
                <div class="absolute inset-0 rounded-full border-4 border-transparent border-t-brand-500 border-r-emerald-500 animate-spin"></div>
                <div class="absolute inset-0 flex items-center justify-center">
                    <svg class="w-6 h-6 text-brand-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/></svg>
                </div>
            </div>
            <p class="text-sm text-slate-500 font-medium">Searching jobs & calculating match scores...</p>
            <p class="text-xs text-slate-400 mt-1">This may take a few seconds</p>
        </div>
        <!-- Error state -->
        <div id="error-state" class="hidden bg-red-50 border border-red-200 rounded-2xl p-8 text-center">
            <svg class="w-10 h-10 text-red-400 mx-auto mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L4.082 16.5c-.77.833.192 2.5 1.732 2.5z"/></svg>
            <h3 class="text-base font-bold text-red-800 mb-1">Search Error</h3>
            <p id="error-message" class="text-sm text-red-600"></p>
        </div>
        <!-- No results -->
        <div id="no-results" class="hidden bg-white rounded-2xl shadow-lg border border-slate-100 p-12 text-center">
            <svg class="w-12 h-12 text-slate-300 mx-auto mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9.172 16.172a4 4 0 015.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
            <h3 class="text-lg font-bold text-slate-700 mb-1">No Jobs Found</h3>
            <p class="text-sm text-slate-500">Try broadening your filters or changing your preferences.</p>
        </div>
        <!-- Quota warning -->
        <p id="quota-warning" class="text-xs text-amber-600 hidden mb-3"></p>
        <!-- Results grid -->
        <div id="jobs-grid" class="hidden space-y-4"></div>
        <!-- Load More button -->
        <div id="load-more-wrap" class="hidden text-center py-6">
            <button onclick="loadMoreJobs()" id="load-more-btn"
                class="inline-flex items-center gap-2 text-sm font-semibold text-brand-600 bg-brand-50 hover:bg-brand-100 border border-brand-200 px-6 py-2.5 rounded-xl transition">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg>
                Load More Jobs
            </button>
            <div id="load-more-spinner" class="hidden inline-flex items-center gap-2 text-sm text-slate-500">
                <svg class="w-4 h-4 animate-spin" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"/><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"/></svg>
                Loading more jobs...
            </div>
        </div>
        <!-- End of results indicator -->
        <div id="no-more-results" class="hidden text-center py-4">
            <p class="text-xs text-slate-400">No more results to load</p>
        </div>
    </div>

</div>

<!-- ===== STYLES ===== -->
<style>
.pill-btn { border-color: #e2e8f0; color: #64748b; background: white; }
.pill-btn.active { border-color: #6366f1; color: #6366f1; background: #eef2ff; font-weight: 600; }
.mpill-btn { border-color: #e2e8f0; color: #64748b; background: white; }
.mpill-btn.active { border-color: #6366f1; color: #6366f1; background: #eef2ff; font-weight: 600; }
.tag-input-wrap { display: flex; flex-wrap: wrap; gap: 6px; align-items: center; min-height: 42px; padding: 6px 10px; border: 1px solid #e2e8f0; border-radius: 12px; background: white; cursor: text; position: relative; }
.tag-input-wrap:focus-within { border-color: #6366f1; box-shadow: 0 0 0 2px rgba(99,102,241,0.2); }
.tag-input-wrap .tag-chip { display: inline-flex; align-items: center; gap: 4px; background: #eef2ff; color: #4338ca; font-size: 12px; font-weight: 500; padding: 2px 8px; border-radius: 999px; white-space: nowrap; }
.tag-input-wrap .tag-chip button { cursor: pointer; color: #6366f1; font-size: 14px; line-height: 1; opacity: 0.6; }
.tag-input-wrap .tag-chip button:hover { opacity: 1; }
.tag-input-wrap input { border: none; outline: none; flex: 1; min-width: 100px; font-size: 13px; padding: 4px 0; background: transparent; }
.tag-autocomplete { position: absolute; top: 100%; left: 0; right: 0; background: white; border: 1px solid #e2e8f0; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); z-index: 20; max-height: 180px; overflow-y: auto; display: none; }
.tag-autocomplete.show { display: block; }
.tag-autocomplete div { padding: 8px 12px; font-size: 13px; cursor: pointer; color: #334155; }
.tag-autocomplete div:hover { background: #f1f5f9; }
.accordion-chevron.open { transform: rotate(180deg); }
</style>

<!-- ===== JAVASCRIPT ===== -->
<script>
let currentCredits = {{ credits_remaining }};
let savedPrefs = {{ preferences_json|safe }};
let currentWizStep = 1;
const totalWizSteps = 3;

// Tag input instances (keyed by container ID)
const tagInstances = {};

// ===================== CASCADING TAXONOMY =====================
let taxonomyData = null;    // { functions: {...}, levels: [...] }
const selectedLocations = {};  // prefix -> Set of city names

async function loadCategoryTree() {
    try {
        const resp = await fetch('/jobs/category-tree');
        const data = await resp.json();
        taxonomyData = data;
    } catch (e) {
        console.error('Failed to load taxonomy:', e);
    }
}

function initCascadeDropdowns(prefix) {
    if (!taxonomyData) return;
    const fnSelect = document.getElementById(prefix + '-job-function');
    if (!fnSelect) return;

    // Populate functions
    fnSelect.innerHTML = '<option value="">Select a function...</option>';
    for (const [funcId, funcData] of Object.entries(taxonomyData.functions || {})) {
        const opt = document.createElement('option');
        opt.value = funcId;
        opt.textContent = funcData.label;
        fnSelect.appendChild(opt);
    }

    // Reset downstream
    resetRoleFamily(prefix);
    resetLevel(prefix);
    clearDerivedTitles(prefix);

}

function onFunctionChange(prefix) {
    const fnSelect = document.getElementById(prefix + '-job-function');
    const roleSection = document.getElementById(prefix + '-role-section');
    const roleSelect = document.getElementById(prefix + '-job-role');
    const selected = fnSelect ? fnSelect.value : '';

    // Clear downstream: role family, level, titles
    resetRoleFamily(prefix);
    resetLevel(prefix);
    clearDerivedTitles(prefix);

    if (!selected || !taxonomyData) {
        if (roleSection) roleSection.classList.add('hidden');
        return;
    }

    const funcData = taxonomyData.functions[selected];
    if (!funcData) return;

    // Populate role families
    roleSelect.innerHTML = '<option value="">Select a role family...</option>';
    for (const [rfId, rfData] of Object.entries(funcData.role_families || {})) {
        const opt = document.createElement('option');
        opt.value = rfId;
        opt.textContent = rfData.label;
        roleSelect.appendChild(opt);
    }
    roleSelect.disabled = false;
    roleSection.classList.remove('hidden');
}

function onRoleFamilyChange(prefix) {
    const fnSelect = document.getElementById(prefix + '-job-function');
    const roleSelect = document.getElementById(prefix + '-job-role');
    const levelSection = document.getElementById(prefix + '-level-section');
    const levelSelect = document.getElementById(prefix + '-job-level');

    const selectedFn = fnSelect ? fnSelect.value : '';
    const selectedRF = roleSelect ? roleSelect.value : '';

    // Clear downstream: level, titles
    resetLevel(prefix);
    clearDerivedTitles(prefix);

    if (!selectedRF || !selectedFn || !taxonomyData) {
        if (levelSection) levelSection.classList.add('hidden');
        return;
    }

    // Populate levels (global, always the same)
    levelSelect.innerHTML = '<option value="">Select a level...</option>';
    (taxonomyData.levels || []).forEach(lv => {
        const opt = document.createElement('option');
        opt.value = lv.id;
        opt.textContent = lv.label;
        levelSelect.appendChild(opt);
    });
    levelSelect.disabled = false;
    levelSection.classList.remove('hidden');

}

function onLevelChange(prefix) {
    const fnSelect = document.getElementById(prefix + '-job-function');
    const roleSelect = document.getElementById(prefix + '-job-role');
    const levelSelect = document.getElementById(prefix + '-job-level');

    const funcId = fnSelect ? fnSelect.value : '';
    const rfId = roleSelect ? roleSelect.value : '';
    const levelId = levelSelect ? levelSelect.value : '';

    // Clear titles
    clearDerivedTitles(prefix);

    if (!funcId || !rfId || !levelId) return;

    // Show titles section and enable the "Get Title Suggestions" button
    const titlesSection = document.getElementById(prefix + '-titles-section');
    if (titlesSection) titlesSection.classList.remove('hidden');

    const suggestBtn = document.getElementById(prefix + '-suggest-titles-btn');
    if (suggestBtn) suggestBtn.disabled = false;
}

// Helper: reset role family select to disabled/empty
function resetRoleFamily(prefix) {
    const roleSelect = document.getElementById(prefix + '-job-role');
    if (roleSelect) {
        roleSelect.innerHTML = '<option value="">Select a role family...</option>';
        roleSelect.disabled = true;
    }
}

// Helper: reset level select to disabled/empty
function resetLevel(prefix) {
    const levelSelect = document.getElementById(prefix + '-job-level');
    const levelSection = document.getElementById(prefix + '-level-section');
    if (levelSelect) {
        levelSelect.innerHTML = '<option value="">Select a level...</option>';
        levelSelect.disabled = true;
    }
    if (levelSection) levelSection.classList.add('hidden');
}

// Helper: clear derived title pills
function clearDerivedTitles(prefix) {
    const titlesSection = document.getElementById(prefix + '-titles-section');
    const titlesPills = document.getElementById(prefix + '-job-titles-pills');
    if (titlesPills) titlesPills.innerHTML = '';
    if (titlesSection) titlesSection.classList.add('hidden');
    const suggestBtn = document.getElementById(prefix + '-suggest-titles-btn');
    if (suggestBtn) suggestBtn.disabled = true;
    const errorEl = document.getElementById(prefix + '-titles-error');
    if (errorEl) { errorEl.classList.add('hidden'); errorEl.textContent = ''; }
}

// ===================== LLM TITLE SUGGESTIONS =====================
async function fetchTitleSuggestions(prefix) {
    const fnSelect = document.getElementById(prefix + '-job-function');
    const roleSelect = document.getElementById(prefix + '-job-role');
    const levelSelect = document.getElementById(prefix + '-job-level');
    const expSelect = document.getElementById(prefix + '-experience');

    const funcId = fnSelect ? fnSelect.value : '';
    const rfId = roleSelect ? roleSelect.value : '';
    const levelId = levelSelect ? levelSelect.value : '';
    const experience = expSelect ? expSelect.value : 'any';

    if (!funcId || !rfId) return;

    const btn = document.getElementById(prefix + '-suggest-titles-btn');
    const loading = document.getElementById(prefix + '-titles-loading');
    const errorEl = document.getElementById(prefix + '-titles-error');
    const titlesPills = document.getElementById(prefix + '-job-titles-pills');

    if (btn) btn.disabled = true;
    if (loading) loading.classList.remove('hidden');
    if (errorEl) { errorEl.classList.add('hidden'); errorEl.textContent = ''; }
    if (titlesPills) titlesPills.innerHTML = '';

    try {
        const resp = await fetch('/jobs/suggest-titles', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ function_id: funcId, role_family_id: rfId, level_id: levelId, experience: experience }),
        });
        const data = await resp.json();
        if (data.error) throw new Error(data.error);

        const titles = data.titles || [];
        const pillSize = prefix === 'wiz' ? 'text-xs px-3 py-1.5' : 'text-[10px] px-2.5 py-1';

        titles.forEach(title => {
            const pill = document.createElement('button');
            pill.type = 'button';
            pill.className = 'mpill-btn active ' + pillSize + ' rounded-full border transition';
            pill.dataset.value = title;
            pill.textContent = title;
            pill.onclick = function() { toggleMultiPill(this); };
            titlesPills.appendChild(pill);
        });

        if (data.fallback && errorEl) {
            errorEl.textContent = 'AI unavailable, showing template titles';
            errorEl.classList.remove('hidden');
        }
    } catch (e) {
        if (errorEl) {
            errorEl.textContent = 'Failed to generate titles. Try again.';
            errorEl.classList.remove('hidden');
        }
    } finally {
        if (loading) loading.classList.add('hidden');
        if (btn) btn.disabled = false;
    }
}

// ===================== LOCATION CITY GRID =====================
const _cities = ['Bangalore','Mumbai','Delhi NCR','Hyderabad','Chennai','Pune','Kolkata','Ahmedabad','Noida','Gurgaon','Jaipur','Chandigarh','Kochi','Indore','Lucknow','Coimbatore','Thiruvananthapuram','Visakhapatnam','Nagpur','Bhubaneswar','Remote'];

if (!selectedLocations['wiz']) selectedLocations['wiz'] = new Set();
if (!selectedLocations['fp']) selectedLocations['fp'] = new Set();

function renderCityGrid(prefix) {
    const grid = document.getElementById(prefix + '-locations-grid');
    if (!grid) return;
    grid.innerHTML = '';
    const s = selectedLocations[prefix] || new Set();
    const isSmall = prefix === 'fp';
    _cities.forEach(city => {
        const btn = document.createElement('button');
        btn.type = 'button';
        btn.dataset.city = city;
        btn.textContent = city;
        if (isSmall) {
            btn.className = 'text-[10px] px-2 py-0.5 rounded-full border transition cursor-pointer';
        } else {
            btn.className = 'text-xs px-3 py-1.5 rounded-full border transition cursor-pointer';
        }
        if (s.has(city)) {
            btn.classList.add('bg-brand-100', 'border-brand-400', 'text-brand-700', 'font-semibold');
        } else {
            btn.classList.add('border-slate-200', 'text-slate-600', 'hover:bg-brand-50', 'hover:border-brand-300');
        }
        btn.onclick = () => toggleLocationSelection(prefix, city);
        grid.appendChild(btn);
    });
}

function toggleLocationSelection(prefix, city) {
    if (!selectedLocations[prefix]) selectedLocations[prefix] = new Set();
    const s = selectedLocations[prefix];
    if (s.has(city)) s.delete(city); else s.add(city);
    renderSelectedChips(prefix);
    renderCityGrid(prefix);
}

function renderSelectedChips(prefix) {
    const container = document.getElementById(prefix + '-locations-selected');
    if (!container) return;
    container.innerHTML = '';
    const s = selectedLocations[prefix] || new Set();
    s.forEach(city => {
        const chip = document.createElement('span');
        chip.className = 'inline-flex items-center gap-1 text-xs bg-brand-50 text-brand-700 px-2 py-0.5 rounded-full';
        chip.innerHTML = escHtml(city) + ' <button type="button" class="hover:text-red-500 font-bold">&times;</button>';
        chip.querySelector('button').onclick = (e) => { e.stopPropagation(); toggleLocationSelection(prefix, city); };
        container.appendChild(chip);
    });
}

// ===================== TAG INPUT WIDGET =====================
function initTagInput(containerId, initialTags) {
    const wrap = document.getElementById(containerId);
    if (!wrap) return;

    // Clear existing
    wrap.innerHTML = '';
    const tags = [];

    // Build input
    const input = document.createElement('input');
    input.type = 'text';
    input.placeholder = 'Type and press Enter...';

    function addTag(text) {
        text = text.trim();
        if (!text || tags.includes(text)) return;
        tags.push(text);
        const chip = document.createElement('span');
        chip.className = 'tag-chip';
        chip.innerHTML = escHtml(text) + '<button type="button">&times;</button>';
        chip.querySelector('button').onclick = () => { chip.remove(); tags.splice(tags.indexOf(text), 1); };
        wrap.insertBefore(chip, input);
        input.value = '';
    }

    input.addEventListener('keydown', (e) => {
        if ((e.key === 'Enter' || e.key === ',') && input.value.trim()) {
            e.preventDefault();
            addTag(input.value);
        }
        if (e.key === 'Backspace' && !input.value && tags.length) {
            const last = tags.pop();
            const chips = wrap.querySelectorAll('.tag-chip');
            if (chips.length) chips[chips.length - 1].remove();
        }
    });

    wrap.appendChild(input);
    wrap.addEventListener('click', () => input.focus());

    // Add initial tags
    (initialTags || []).forEach(t => addTag(t));

    tagInstances[containerId] = { getTags: () => [...tags], addTag };
}

// ===================== PILL TOGGLES =====================
function togglePill(btn, groupId) {
    // Single-select: deactivate siblings, activate this
    const container = groupId ? document.getElementById(groupId) : btn.parentElement;
    if (!container) return;
    container.querySelectorAll('.pill-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
}

function toggleMultiPill(btn) {
    btn.classList.toggle('active');
}

function getActivePill(groupId) {
    const el = document.getElementById(groupId);
    if (!el) return null;
    const active = el.querySelector('.pill-btn.active');
    return active ? active.dataset.value : 'any';
}

function getActiveMultiPills(groupId) {
    const el = document.getElementById(groupId);
    if (!el) return [];
    return Array.from(el.querySelectorAll('.mpill-btn.active')).map(b => b.dataset.value);
}

function setActivePill(groupId, value) {
    const el = document.getElementById(groupId);
    if (!el) return;
    el.querySelectorAll('.pill-btn').forEach(b => {
        b.classList.toggle('active', b.dataset.value === value);
    });
}

function setActiveMultiPills(groupId, values) {
    const el = document.getElementById(groupId);
    if (!el) return;
    el.querySelectorAll('.mpill-btn').forEach(b => {
        b.classList.toggle('active', (values || []).includes(b.dataset.value));
    });
}

// ===================== ACCORDION =====================
function toggleAccordion(id) {
    const el = document.getElementById(id);
    if (!el) return;
    const isHidden = el.classList.contains('hidden');
    el.classList.toggle('hidden');
    const chevron = el.previousElementSibling.querySelector('.accordion-chevron');
    if (chevron) chevron.classList.toggle('open', isHidden);
}

// ===================== SALARY PRESETS =====================
function setSalaryPreset(min, max) {
    const minEl = document.getElementById('wiz-salary-min') || document.getElementById('fp-salary-min');
    const maxEl = document.getElementById('wiz-salary-max') || document.getElementById('fp-salary-max');
    if (minEl) minEl.value = min || '';
    if (maxEl) maxEl.value = max || '';
}

// ===================== WIZARD NAVIGATION =====================
function wizStep(dir) {
    const next = currentWizStep + dir;
    if (next < 1 || next > totalWizSteps) {
        if (next > totalWizSteps) savePreferencesAndSearch('wiz');
        return;
    }
    document.getElementById('wiz-step-' + currentWizStep).classList.add('hidden');
    document.getElementById('wiz-step-' + next).classList.remove('hidden');
    currentWizStep = next;

    // Update dots
    for (let i = 1; i <= totalWizSteps; i++) {
        document.getElementById('step-dot-' + i).className = 'h-1.5 flex-1 rounded-full transition-colors ' + (i <= currentWizStep ? 'bg-brand-500' : 'bg-slate-200');
    }

    // Show/hide back button
    document.getElementById('wiz-back-btn').classList.toggle('hidden', currentWizStep === 1);

    // Change next button text on last step
    const nextBtn = document.getElementById('wiz-next-btn');
    if (currentWizStep === totalWizSteps) {
        nextBtn.innerHTML = '<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/></svg> Save & Search Jobs';
    } else {
        nextBtn.innerHTML = 'Next <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/></svg>';
    }
}

function skipWizard() {
    const overlay = document.getElementById('wizard-overlay');
    if (overlay) overlay.remove();
}

// ===================== COLLECT PREFERENCES =====================
function collectPreferences(prefix) {
    // Job titles from multi-select pills (derived, optional)
    const titlePills = document.getElementById(prefix + '-job-titles-pills');
    const jobTitles = titlePills
        ? Array.from(titlePills.querySelectorAll('.mpill-btn.active')).map(b => b.dataset.value)
        : [];

    // Function ID from dropdown (single value -> array for backward compat)
    const fnEl = document.getElementById(prefix + '-job-function');
    const industries = fnEl && fnEl.value ? [fnEl.value] : [];

    // Role Family ID from dropdown (single value -> array)
    const roleEl = document.getElementById(prefix + '-job-role');
    const functionalAreas = roleEl && roleEl.value ? [roleEl.value] : [];

    // Level ID from dropdown (single string)
    const levelEl = document.getElementById(prefix + '-job-level');
    const level = levelEl ? levelEl.value : '';

    // Locations from selection set (not tag input)
    const locations = selectedLocations[prefix]
        ? Array.from(selectedLocations[prefix])
        : [];

    return {
        job_titles: jobTitles,
        experience_level: (document.getElementById(prefix + '-experience') || {}).value || 'any',
        employment_types: getActiveMultiPills(prefix + '-emp-types'),
        work_mode: getActivePill(prefix + '-work-mode'),
        locations: locations,
        salary_min: (document.getElementById(prefix + '-salary-min') || {}).value || null,
        salary_max: (document.getElementById(prefix + '-salary-max') || {}).value || null,
        salary_period: getActivePill(prefix + '-salary-period') || 'annual',
        industries: industries,
        functional_areas: functionalAreas,
        level: level,
    };
}

// ===================== SAVE & SEARCH =====================
async function savePreferencesAndSearch(prefix) {
    const prefs = collectPreferences(prefix);

    // Save to server
    try {
        const resp = await fetch('/jobs/preferences', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(prefs),
        });
        const data = await resp.json();
        if (data.success) {
            savedPrefs = data.preferences;
        }
    } catch (e) {
        console.error('Failed to save preferences:', e);
    }

    // Close wizard if open
    const overlay = document.getElementById('wizard-overlay');
    if (overlay) overlay.remove();

    // Update summary bar (includes Edit Filters button)
    updatePrefsSummary(prefs);

    // Trigger search (force=true to bypass cache after pref change)
    searchWithPrefs(true);
}

async function updateAndSearch() {
    await savePreferencesAndSearch('fp');
    closeFilterPanel();
}

// ===================== SEARCH FUNCTIONS =====================

async function loadJobsPage() {
    // Snapshot-first loading: serve cached results instantly, refresh if stale
    showState('loading');
    try {
        const resp = await fetch('/jobs/snapshot');
        const snap = await resp.json();
        if (snap.has_snapshot && snap.jobs && snap.jobs.length > 0) {
            // Instant render from snapshot
            const countEl = document.getElementById('result-count');
            const ageLabel = snap.snapshot_age_minutes < 60
                ? snap.snapshot_age_minutes + 'm ago'
                : Math.round(snap.snapshot_age_minutes / 60) + 'h ago';
            countEl.textContent = snap.jobs.length + ' job' + (snap.jobs.length !== 1 ? 's' : '') + ' (cached ' + ageLabel + ')';
            countEl.classList.remove('hidden');
            renderJobs(snap.jobs);
            showState('grid');
            // Snapshot is always page 1 — show Load More
            _currentPage = 1;
            _hasMoreResults = true;
            if (snap.jobs.length >= 10) _showLoadMore();
            // If stale or older than 2 hours, refresh in background
            if (snap.is_stale || snap.snapshot_age_minutes > 120) {
                searchWithPrefs();
            }
            return;
        }
    } catch (e) {
        console.log('Snapshot unavailable, falling back to search');
    }
    // No snapshot — do normal search
    searchWithPrefs();
}

let _searchGeneration = 0;  // Incremented on each search to prevent stale race conditions
let _currentPage = 1;       // Current page for pagination
let _hasMoreResults = true;  // Whether there are more pages to load
let _isLoadingMore = false;  // Prevent concurrent load-more requests

async function searchWithPrefs(force) {
    const thisGen = ++_searchGeneration;
    _currentPage = 1;
    _hasMoreResults = true;
    showState('loading');
    _hideLoadMore();

    try {
        const url = '/jobs/search?use_preferences=1&page=1' + (force ? '&force=1' : '');
        const resp = await fetch(url);
        const data = await resp.json();

        // If a newer search was triggered while this one was in-flight, discard results
        if (thisGen !== _searchGeneration) return;

        if (data.error) {
            document.getElementById('error-message').textContent = data.error;
            showState('error');
            return;
        }

        if (!data.jobs || data.jobs.length === 0) {
            showState('no-results');
            return;
        }

        const countEl = document.getElementById('result-count');
        let sourceLabel = '';
        if (data.source === 'cache' || data.source === 'pool') sourceLabel = ' (cached)';
        else if (data.sources && data.sources.length > 1) sourceLabel = ' (from ' + data.sources.length + ' sources)';
        countEl.textContent = data.jobs.length + ' job' + (data.jobs.length !== 1 ? 's' : '') + ' found' + sourceLabel;
        countEl.classList.remove('hidden');

        const warnEl = document.getElementById('quota-warning');
        if (warnEl) {
            if (data.warning) { warnEl.textContent = data.warning; warnEl.classList.remove('hidden'); }
            else { warnEl.classList.add('hidden'); }
        }

        renderJobs(data.jobs);
        showState('grid');

        // Show Load More if we got a full page (~10 results)
        if (data.jobs.length >= 10) {
            _showLoadMore();
        }
    } catch (err) {
        if (thisGen !== _searchGeneration) return;  // Ignore errors from superseded searches
        document.getElementById('error-message').textContent = 'Network error. Please try again.';
        showState('error');
    }
}

// ===================== LOAD MORE (PAGINATION) =====================
async function loadMoreJobs() {
    if (_isLoadingMore || !_hasMoreResults) return;
    _isLoadingMore = true;

    const btn = document.getElementById('load-more-btn');
    const spinner = document.getElementById('load-more-spinner');
    if (btn) btn.classList.add('hidden');
    if (spinner) spinner.classList.remove('hidden');

    const nextPage = _currentPage + 1;
    const thisGen = _searchGeneration;  // Capture current generation

    try {
        const url = '/jobs/search?use_preferences=1&page=' + nextPage;
        const resp = await fetch(url);
        const data = await resp.json();

        // Discard if a new search was started while loading more
        if (thisGen !== _searchGeneration) { _isLoadingMore = false; return; }

        if (data.error || !data.jobs || data.jobs.length === 0) {
            _hasMoreResults = false;
            _hideLoadMore();
            document.getElementById('no-more-results').classList.remove('hidden');
            _isLoadingMore = false;
            return;
        }

        _currentPage = nextPage;

        // Append new jobs to grid
        appendJobs(data.jobs);

        // Update result count
        const totalJobs = (window._jobResults || []).length;
        const countEl = document.getElementById('result-count');
        countEl.textContent = totalJobs + ' job' + (totalJobs !== 1 ? 's' : '') + ' found';
        countEl.classList.remove('hidden');

        // Always show Load More — only stop when API returns 0 results (handled above)
        _showLoadMore();
    } catch (err) {
        if (thisGen !== _searchGeneration) { _isLoadingMore = false; return; }
        // Show the button again on error so user can retry
        _showLoadMore();
    } finally {
        _isLoadingMore = false;
    }
}

function _showLoadMore() {
    const wrap = document.getElementById('load-more-wrap');
    const btn = document.getElementById('load-more-btn');
    const spinner = document.getElementById('load-more-spinner');
    if (wrap) wrap.classList.remove('hidden');
    if (btn) btn.classList.remove('hidden');
    if (spinner) spinner.classList.add('hidden');
    document.getElementById('no-more-results').classList.add('hidden');
}

function _hideLoadMore() {
    const wrap = document.getElementById('load-more-wrap');
    if (wrap) wrap.classList.add('hidden');
}

function showState(state) {
    ['empty-state', 'loading-state', 'error-state', 'no-results', 'jobs-grid'].forEach(id => {
        document.getElementById(id).classList.add('hidden');
    });
    const map = { empty: 'empty-state', loading: 'loading-state', error: 'error-state', 'no-results': 'no-results', grid: 'jobs-grid' };
    if (map[state]) document.getElementById(map[state]).classList.remove('hidden');
    // Hide pagination elements when not showing grid
    if (state !== 'grid') {
        _hideLoadMore();
        document.getElementById('no-more-results').classList.add('hidden');
    }
}

// ===================== PREFERENCES SUMMARY =====================
function updatePrefsSummary(prefs) {
    const parts = [];
    // Function label
    if (prefs.industries && prefs.industries.length && taxonomyData && taxonomyData.functions) {
        const func = taxonomyData.functions[prefs.industries[0]];
        if (func) parts.push(func.label); else parts.push(prefs.industries[0]);
    }
    // Role Family label
    if (prefs.functional_areas && prefs.functional_areas.length && prefs.industries && prefs.industries.length && taxonomyData && taxonomyData.functions) {
        const func = taxonomyData.functions[prefs.industries[0]];
        if (func && func.role_families) {
            const rf = func.role_families[prefs.functional_areas[0]];
            if (rf) parts.push(rf.label); else parts.push(prefs.functional_areas[0]);
        }
    }
    // Level label
    if (prefs.level && taxonomyData && taxonomyData.levels) {
        const lv = taxonomyData.levels.find(l => l.id === prefs.level);
        if (lv) parts.push(lv.label); else parts.push(prefs.level);
    }
    if (prefs.job_titles && prefs.job_titles.length) parts.push(prefs.job_titles.slice(0, 2).join(', '));
    if (prefs.locations && prefs.locations.length) parts.push(prefs.locations.slice(0, 2).join(', '));
    const empMap = { FULLTIME: 'Full-time', PARTTIME: 'Part-time', CONTRACTOR: 'Contract', INTERN: 'Internship' };
    if (prefs.employment_types && prefs.employment_types.length) parts.push(prefs.employment_types.map(t => empMap[t] || t).join(', '));
    if (prefs.work_mode && prefs.work_mode !== 'any') parts.push(prefs.work_mode.charAt(0).toUpperCase() + prefs.work_mode.slice(1));
    if (prefs.salary_min || prefs.salary_max) {
        const fmt = n => (n / 100000).toFixed(1) + 'L';
        if (prefs.salary_min && prefs.salary_max) parts.push(fmt(prefs.salary_min) + '-' + fmt(prefs.salary_max));
        else if (prefs.salary_min) parts.push(fmt(prefs.salary_min) + '+');
        else parts.push('Up to ' + fmt(prefs.salary_max));
    }
    const summaryEl = document.getElementById('prefs-summary');
    const textEl = document.getElementById('prefs-summary-text');
    if (parts.length) {
        textEl.textContent = parts.join('  \u00b7  ');
        summaryEl.classList.remove('hidden');
    } else {
        summaryEl.classList.add('hidden');
    }
}

// ===================== FILTER PANEL =====================
function openEditPrefs() {
    const panel = document.getElementById('filter-panel');
    panel.classList.remove('hidden');

    // Init cascade dropdowns for filter panel
    initCascadeDropdowns('fp');

    if (savedPrefs) {
        // Restore cascade: function → role family → level → derived titles
        const fpFn = document.getElementById('fp-job-function');
        if (fpFn && savedPrefs.industries && savedPrefs.industries.length) {
            fpFn.value = savedPrefs.industries[0];
            onFunctionChange('fp');

            const fpRole = document.getElementById('fp-job-role');
            if (fpRole && savedPrefs.functional_areas && savedPrefs.functional_areas.length) {
                setTimeout(() => {
                    fpRole.value = savedPrefs.functional_areas[0];
                    onRoleFamilyChange('fp');

                    const fpLevel = document.getElementById('fp-job-level');
                    if (fpLevel && savedPrefs.level) {
                        setTimeout(() => {
                            fpLevel.value = savedPrefs.level;
                            onLevelChange('fp');

                            // Restore previously selected title pills
                            setTimeout(() => {
                                if (savedPrefs.job_titles) {
                                    setActiveMultiPills('fp-job-titles-pills', savedPrefs.job_titles);
                                }
                            }, 50);
                        }, 50);
                    }
                }, 50);
            }
        }

        // Restore work preferences
        document.getElementById('fp-experience').value = savedPrefs.experience_level || 'any';
        setActivePill('fp-work-mode', savedPrefs.work_mode || 'any');
        setActiveMultiPills('fp-emp-types', savedPrefs.employment_types);

        // Restore locations
        selectedLocations['fp'] = new Set(savedPrefs.locations || []);
        renderSelectedChips('fp');
        renderCityGrid('fp');

        // Restore salary
        document.getElementById('fp-salary-min').value = savedPrefs.salary_min || '';
        document.getElementById('fp-salary-max').value = savedPrefs.salary_max || '';
        setActivePill('fp-salary-period', savedPrefs.salary_period || 'annual');

    } else {
        // No saved prefs
        selectedLocations['fp'] = new Set();
        renderCityGrid('fp');
    }
}

function closeFilterPanel() {
    document.getElementById('filter-panel').classList.add('hidden');
}

// ===================== RENDER JOBS =====================
function _buildJobCard(job, idx) {
    const card = document.createElement('div');
    card.className = 'bg-white rounded-2xl shadow-sm border border-slate-200 p-5 hover:shadow-md transition';
    card.id = 'job-card-' + idx;

    let scoreBadge = '';
    {
        const useDeep = job.has_deep_score && job.deep_ats_score !== undefined;
        const s = useDeep ? job.deep_ats_score : job.ats_score;
        const scoreLabel = useDeep ? 'AI Score' : 'Quick';
        if (s !== null && s !== undefined) {
            let sc, sl;
            if (s >= 85) { sc = 'bg-emerald-100 text-emerald-700'; sl = 'Great Match'; }
            else if (s >= 70) { sc = 'bg-blue-100 text-blue-700'; sl = 'Good Match'; }
            else if (s >= 50) { sc = 'bg-amber-100 text-amber-700'; sl = 'Fair Match'; }
            else if (s >= 30) { sc = 'bg-orange-100 text-orange-700'; sl = 'Low Match'; }
            else { sc = 'bg-red-100 text-red-700'; sl = 'Weak Match'; }
            scoreBadge = `<div class="text-center flex-shrink-0">
                <span class="inline-flex items-center justify-center w-11 h-7 rounded-lg font-bold text-sm ${sc}">${s}</span>
                <span class="block mt-0.5 text-[9px] font-bold px-1.5 py-0.5 rounded-full ${sc}">${sl}</span>
                <span class="block mt-0.5 text-[8px] text-slate-400">${scoreLabel}</span>
            </div>`;
        }
    }

    let tags = '';
    if (job.employment_type) tags += `<span class="text-[10px] font-medium px-2 py-0.5 rounded-full bg-slate-100 text-slate-600">${job.employment_type}</span>`;
    if (job.is_remote) tags += '<span class="text-[10px] font-medium px-2 py-0.5 rounded-full bg-emerald-50 text-emerald-600">Remote</span>';
    if (job.salary_min) tags += `<span class="text-[10px] font-medium px-2 py-0.5 rounded-full bg-blue-50 text-blue-600">${formatSalary(job)}</span>`;
    if (job.posted_date) tags += `<span class="text-[10px] font-medium px-2 py-0.5 rounded-full bg-slate-50 text-slate-500">${job.posted_date}</span>`;
    // Source badge (show for non-JSearch providers)
    if (job.source && job.source !== 'jsearch') {
        const _srcColors = { adzuna: 'bg-purple-50 text-purple-600', jooble: 'bg-cyan-50 text-cyan-600', remoteok: 'bg-green-50 text-green-600', remotive: 'bg-indigo-50 text-indigo-600' };
        const _srcNames = { adzuna: 'Adzuna', jooble: 'Jooble', remoteok: 'RemoteOK', remotive: 'Remotive' };
        tags += `<span class="text-[10px] font-medium px-2 py-0.5 rounded-full ${_srcColors[job.source] || 'bg-slate-50 text-slate-500'}">${_srcNames[job.source] || job.source}</span>`;
    }

    const logo = job.company_logo
        ? `<img src="${escHtml(job.company_logo)}" class="w-full h-full object-contain rounded-lg" onerror="this.parentElement.innerHTML='<span class=\\'text-lg font-bold text-slate-400\\'>${escHtml((job.company || '?')[0])}</span>'">`
        : `<span class="text-lg font-bold text-slate-400">${escHtml((job.company || '?')[0])}</span>`;

    card.innerHTML = `
        <div class="flex items-start gap-4">
            <div class="w-12 h-12 bg-slate-100 rounded-xl flex items-center justify-center flex-shrink-0 overflow-hidden">${logo}</div>
            <div class="flex-1 min-w-0">
                <h3 class="text-sm font-bold text-slate-800 leading-snug">${escHtml(job.title)}</h3>
                <p class="text-xs text-slate-500 mt-0.5">${escHtml(job.company)}${job.location ? ' &middot; ' + escHtml(job.location) : ''}</p>
                <div class="flex flex-wrap gap-1.5 mt-2">${tags}</div>
                <p class="text-xs text-slate-400 mt-2 line-clamp-2">${escHtml(job.description_snippet || '')}</p>
                <div class="flex items-center gap-2 mt-3">
                    ${job.apply_url ? `<a href="${escHtml(job.apply_url)}" target="_blank" rel="noopener" class="inline-flex items-center gap-1.5 text-xs font-semibold text-white bg-brand-600 hover:bg-brand-700 px-4 py-1.5 rounded-lg transition">Apply <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"/></svg></a>` : ''}
                    <button onclick="deepAnalyze(${idx}, this)" data-job-idx="${idx}"
                        class="deep-analyze-btn inline-flex items-center gap-1.5 text-xs font-semibold text-brand-600 bg-brand-50 hover:bg-brand-100 px-3 py-1.5 rounded-lg transition">
                        <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/></svg>
                        Deep Analyze (3 credits)
                    </button>
                </div>
            </div>
            <div class="hidden sm:block">${scoreBadge}</div>
        </div>
        ${scoreBadge ? `<div class="sm:hidden flex justify-end mt-3 pt-3 border-t border-slate-100">${scoreBadge}</div>` : ''}
    `;
    return card;
}

function renderJobs(jobs) {
    const grid = document.getElementById('jobs-grid');
    grid.innerHTML = '';
    window._jobResults = [];

    jobs.forEach((job, i) => {
        window._jobResults.push(job);
        grid.appendChild(_buildJobCard(job, i));
    });

    grid.classList.remove('hidden');
}

function appendJobs(newJobs) {
    const grid = document.getElementById('jobs-grid');
    if (!window._jobResults) window._jobResults = [];

    // Deduplicate against existing results
    const existingIds = new Set(window._jobResults.map(j => j.job_id).filter(Boolean));
    const uniqueNewJobs = newJobs.filter(j => !j.job_id || !existingIds.has(j.job_id));

    uniqueNewJobs.forEach(job => {
        const idx = window._jobResults.length;
        window._jobResults.push(job);
        grid.appendChild(_buildJobCard(job, idx));
    });
}

// ===================== DEEP ANALYZE (unchanged) =====================
async function deepAnalyze(idx, btn) {
    const job = window._jobResults[idx];
    if (!job) return;
    if (currentCredits < 3) { alert('You need 3 credits. You have ' + currentCredits + '. Buy more first.'); return; }
    if (!confirm('Deep ATS analysis costs 3 credits. You have ' + currentCredits + '. Proceed?')) return;

    const origHTML = btn.innerHTML;
    btn.disabled = true;
    btn.innerHTML = '<svg class="w-3 h-3 animate-spin" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"/><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"/></svg> Analyzing...';

    try {
        const resp = await fetch('/jobs/deep-analyze', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ job_id: job.job_id, description: job.description }),
        });
        const data = await resp.json();
        if (data.error) { alert(data.error); btn.disabled = false; btn.innerHTML = origHTML; return; }
        if (data.credits_remaining !== undefined) currentCredits = data.credits_remaining;

        const card = document.getElementById('job-card-' + idx);
        if (card && data.ats_score !== undefined) {
            const s = data.ats_score;
            let sc, sl;
            if (s >= 85) { sc = 'bg-emerald-100 text-emerald-700'; sl = 'Great Match'; }
            else if (s >= 70) { sc = 'bg-blue-100 text-blue-700'; sl = 'Good Match'; }
            else if (s >= 50) { sc = 'bg-amber-100 text-amber-700'; sl = 'Fair Match'; }
            else if (s >= 30) { sc = 'bg-orange-100 text-orange-700'; sl = 'Low Match'; }
            else { sc = 'bg-red-100 text-red-700'; sl = 'Weak Match'; }
            const newBadge = `<div class="text-center flex-shrink-0"><span class="inline-flex items-center justify-center w-11 h-7 rounded-lg font-bold text-sm ${sc}">${s}</span><span class="block mt-0.5 text-[9px] font-bold px-1.5 py-0.5 rounded-full ${sc}">${sl}</span><span class="block mt-0.5 text-[8px] text-slate-400">AI Score</span></div>`;
            const ds = card.querySelector('.hidden.sm\\:block'); if (ds) ds.innerHTML = newBadge;
            const ms = card.querySelector('.sm\\:hidden.flex.justify-end'); if (ms) ms.innerHTML = newBadge;
        }
        btn.className = 'inline-flex items-center gap-1.5 text-xs font-semibold text-emerald-600 bg-emerald-50 px-3 py-1.5 rounded-lg';
        btn.innerHTML = '<svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/></svg> Deep Score: ' + data.ats_score;
        btn.disabled = true;
    } catch (err) { alert('Network error. Please try again.'); btn.disabled = false; btn.innerHTML = origHTML; }
}

function formatSalary(job) {
    if (!job.salary_min) return '';
    const curr = job.salary_currency || '$';
    const period = job.salary_period || 'year';
    if (job.salary_max) return curr + Number(job.salary_min).toLocaleString() + '-' + curr + Number(job.salary_max).toLocaleString() + '/' + period;
    return curr + Number(job.salary_min).toLocaleString() + '/' + period;
}

function escHtml(str) {
    if (!str) return '';
    const div = document.createElement('div');
    div.textContent = str;
    return div.innerHTML;
}

// ===================== INIT ON PAGE LOAD =====================
document.addEventListener('DOMContentLoaded', () => {
    loadCategoryTree().then(() => {
        {% if show_wizard %}
        // Wizard mode: init cascade + city grid
        initCascadeDropdowns('wiz');
        selectedLocations['wiz'] = new Set();
        renderCityGrid('wiz');
        {% else %}
        // Return visit: load snapshot
        if (savedPrefs && savedPrefs.setup_completed) {
            updatePrefsSummary(savedPrefs);
            loadJobsPage();
        }
        {% endif %}
    });
});
</script>

{% endblock %}
