{% extends "dashboard_base.html" %}
{% block title %}Interview Feedback ‚Äî {{ iv_session.target_role }} ‚Äî LevelUpX{% endblock %}
{% block page_title %}Interview Feedback{% endblock %}
{% block content %}

{% set score = feedback.get('overall_score', 0)|int %}
{% if score >= 75 %}{% set score_color = '#10b981' %}{% set score_label = 'Strong' %}
{% elif score >= 50 %}{% set score_color = '#f59e0b' %}{% set score_label = 'Adequate' %}
{% else %}{% set score_color = '#ef4444' %}{% set score_label = 'Needs Work' %}{% endif %}

{% set dim_meta = [
    ('communication',       'Communication',      '#6366f1', 'üí¨'),
    ('content_depth',       'Content Depth',       '#8b5cf6', 'üìö'),
    ('structure',           'Structure & STAR',    '#10b981', 'üìã'),
    ('technical_accuracy',  'Technical Accuracy',  '#f59e0b', '‚öôÔ∏è'),
    ('problem_solving',     'Problem Solving',     '#ef4444', 'üí°'),
    ('confidence_presence', 'Confidence',          '#ec4899', 'üéØ')
] %}

<style>
    .score-ring { position:relative; width:120px; height:120px; border-radius:50%; display:flex; align-items:center; justify-content:center; }
    .score-ring-inner { width:92px; height:92px; border-radius:50%; background:#0f172a; display:flex; flex-direction:column; align-items:center; justify-content:center; }
    .dim-bar-track { width:100%; height:10px; background:#f1f5f9; border-radius:99px; overflow:hidden; }
    .dim-bar-fill { height:100%; border-radius:99px; transition:width 1.2s cubic-bezier(.22,1,.36,1); }
    .q-badge { min-width:40px; height:40px; border-radius:12px; display:flex; align-items:center; justify-content:center; font-weight:800; font-size:14px; flex-shrink:0; }
    details summary::-webkit-details-marker { display:none; }
    details summary { list-style:none; }
    .chevron { transition:transform 0.2s ease; }
    details[open] .chevron { transform:rotate(180deg); }
    .radar-poly { transform-origin:270px 220px; animation:radarGrow 1s cubic-bezier(.22,1,.36,1) forwards; }
    @keyframes radarGrow { from{transform:scale(0);opacity:0} to{transform:scale(1);opacity:1} }
    .radar-dot { opacity:0; animation:dotPop .4s cubic-bezier(.22,1,.36,1) forwards; }
    @keyframes dotPop { from{opacity:0} to{opacity:1} }
</style>

<div class="max-w-4xl mx-auto space-y-6 pb-8">

    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê HEADER ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <div class="bg-gradient-to-br from-slate-800 via-slate-900 to-indigo-950 rounded-2xl p-6 text-white shadow-xl">
        <div class="flex flex-col sm:flex-row items-center gap-6">
            <div class="score-ring" style="background:conic-gradient({{ score_color }} {{ (score * 3.6)|int }}deg, rgba(255,255,255,0.08) 0deg);">
                <div class="score-ring-inner">
                    <span class="text-3xl font-black leading-none" style="color:{{ score_color }}">{{ score }}</span>
                    <span class="text-[10px] font-semibold mt-1 opacity-80" style="color:{{ score_color }}">{{ score_label }}</span>
                </div>
            </div>
            <div class="flex-1 text-center sm:text-left">
                <h1 class="text-xl font-bold">{{ iv_session.target_role }}</h1>
                <div class="flex flex-wrap justify-center sm:justify-start gap-2 mt-2">
                    <span class="text-[11px] bg-white/10 px-2.5 py-0.5 rounded-full">{{ iv_session.interview_type|capitalize }}</span>
                    <span class="text-[11px] bg-white/10 px-2.5 py-0.5 rounded-full">{{ iv_session.difficulty|capitalize }}</span>
                    <span class="text-[11px] bg-white/10 px-2.5 py-0.5 rounded-full">{{ iv_session.duration_minutes }} min</span>
                    <span class="text-[11px] bg-white/10 px-2.5 py-0.5 rounded-full">{{ iv_session.persona|capitalize }}</span>
                    {% if iv_session.started_at %}
                    <span class="text-[11px] bg-white/10 px-2.5 py-0.5 rounded-full">{{ iv_session.started_at.strftime('%d %b %Y') }}</span>
                    {% endif %}
                </div>
                <p class="text-sm text-white/60 mt-3 leading-relaxed">{{ feedback.get('summary', 'Interview completed.') }}</p>
            </div>
        </div>
    </div>

    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê PERFORMANCE RADAR CHART (SVG) ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    {% set dims = feedback.get('dimensions', {}) if dims is not defined else dims %}
    {# Pre-compute cos/sin for 6 vertices (top, then clockwise) #}
    {% set trig = [
        (0.0, -1.0),
        (0.866, -0.5),
        (0.866, 0.5),
        (0.0, 1.0),
        (-0.866, 0.5),
        (-0.866, -0.5)
    ] %}
    {% set cx = 270 %}
    {% set cy = 220 %}
    {% set R = 150 %}
    {# Compute average score #}
    {% set ns = namespace(total=0, count=0, score_pts='') %}
    {% for key, label, color, emoji in dim_meta %}
        {% set dscore = dims.get(key, {}).get('score', 0)|int %}
        {% set ns.total = ns.total + dscore %}
        {% set ns.count = ns.count + 1 %}
        {% set cosv = trig[loop.index0][0] %}
        {% set sinv = trig[loop.index0][1] %}
        {% set px = cx + (dscore / 100.0 * R * cosv)|round|int %}
        {% set py = cy + (dscore / 100.0 * R * sinv)|round|int %}
        {% if loop.index0 == 0 %}
            {% set ns.score_pts = px|string ~ ',' ~ py|string %}
        {% else %}
            {% set ns.score_pts = ns.score_pts ~ ' ' ~ px|string ~ ',' ~ py|string %}
        {% endif %}
    {% endfor %}
    {% set avg = (ns.total / ns.count)|round|int if ns.count > 0 else 0 %}

    <div class="bg-white rounded-2xl shadow-sm border border-slate-200 p-6">
        <h2 class="text-base font-bold text-slate-800 mb-2">Performance Breakdown</h2>
        <div class="flex justify-center">
            <svg viewBox="0 0 540 460" style="max-width:480px; width:100%;" xmlns="http://www.w3.org/2000/svg">
                <defs>
                    <linearGradient id="radarFill" x1="0%" y1="0%" x2="100%" y2="100%">
                        <stop offset="0%" stop-color="#6366f1" stop-opacity="0.25"/>
                        <stop offset="50%" stop-color="#8b5cf6" stop-opacity="0.18"/>
                        <stop offset="100%" stop-color="#ec4899" stop-opacity="0.25"/>
                    </linearGradient>
                    <linearGradient id="radarStroke" x1="0%" y1="0%" x2="100%" y2="100%">
                        <stop offset="0%" stop-color="#6366f1"/>
                        <stop offset="50%" stop-color="#10b981"/>
                        <stop offset="100%" stop-color="#ec4899"/>
                    </linearGradient>
                </defs>

                {# ‚îÄ‚îÄ Grid rings (5 levels: 20%, 40%, 60%, 80%, 100%) ‚îÄ‚îÄ #}
                {% for pct in [20, 40, 60, 80, 100] %}
                    {% set rns = namespace(ring='') %}
                    {% for i in range(6) %}
                        {% set gx = cx + (pct / 100.0 * R * trig[i][0])|round|int %}
                        {% set gy = cy + (pct / 100.0 * R * trig[i][1])|round|int %}
                        {% if i == 0 %}
                            {% set rns.ring = gx|string ~ ',' ~ gy|string %}
                        {% else %}
                            {% set rns.ring = rns.ring ~ ' ' ~ gx|string ~ ',' ~ gy|string %}
                        {% endif %}
                    {% endfor %}
                    <polygon points="{{ rns.ring }}" fill="none" stroke="#e2e8f0" stroke-width="{% if pct == 100 %}1.5{% else %}0.8{% endif %}"/>
                {% endfor %}

                {# ‚îÄ‚îÄ Dashed axis lines ‚îÄ‚îÄ #}
                {% for i in range(6) %}
                    {% set ax = cx + (R * trig[i][0])|round|int %}
                    {% set ay = cy + (R * trig[i][1])|round|int %}
                    <line x1="{{ cx }}" y1="{{ cy }}" x2="{{ ax }}" y2="{{ ay }}" stroke="#e2e8f0" stroke-width="0.8" stroke-dasharray="4,4"/>
                {% endfor %}

                {# ‚îÄ‚îÄ Score polygon ‚îÄ‚îÄ #}
                <polygon points="{{ ns.score_pts }}" fill="url(#radarFill)" stroke="url(#radarStroke)" stroke-width="2.5" stroke-linejoin="round" class="radar-poly"/>

                {# ‚îÄ‚îÄ Colored dots + labels ‚îÄ‚îÄ #}
                {% for key, label, color, emoji in dim_meta %}
                    {% set dscore = dims.get(key, {}).get('score', 0)|int %}
                    {% set cosv = trig[loop.index0][0] %}
                    {% set sinv = trig[loop.index0][1] %}
                    {% set dx = cx + (dscore / 100.0 * R * cosv)|round|int %}
                    {% set dy = cy + (dscore / 100.0 * R * sinv)|round|int %}
                    {# Dot at score position #}
                    <circle cx="{{ dx }}" cy="{{ dy }}" r="5" fill="{{ color }}" stroke="white" stroke-width="2" class="radar-dot" style="animation-delay:{{ loop.index0 * 0.1 + 0.6 }}s"/>

                    {# Label position ‚Äî pushed further out from vertex #}
                    {% set lx = cx + (185 * cosv)|round|int %}
                    {% set ly = cy + (185 * sinv)|round|int %}
                    {# text-anchor: middle for top/bottom, start for right, end for left #}
                    {% if loop.index0 == 0 %}
                        {# Top #}
                        <text x="{{ lx }}" y="{{ ly - 8 }}" text-anchor="middle" fill="#334155" font-size="12" font-weight="600">{{ label }}</text>
                        <text x="{{ lx }}" y="{{ ly + 6 }}" text-anchor="middle" fill="{{ color }}" font-size="13" font-weight="800">{{ dscore }}</text>
                    {% elif loop.index0 == 3 %}
                        {# Bottom #}
                        <text x="{{ lx }}" y="{{ ly + 10 }}" text-anchor="middle" fill="#334155" font-size="12" font-weight="600">{{ label }}</text>
                        <text x="{{ lx }}" y="{{ ly + 25 }}" text-anchor="middle" fill="{{ color }}" font-size="13" font-weight="800">{{ dscore }}</text>
                    {% elif loop.index0 in [1, 2] %}
                        {# Right side #}
                        <text x="{{ lx + 8 }}" y="{{ ly - 4 }}" text-anchor="start" fill="#334155" font-size="12" font-weight="600">{{ label }}</text>
                        <text x="{{ lx + 8 }}" y="{{ ly + 11 }}" text-anchor="start" fill="{{ color }}" font-size="13" font-weight="800">{{ dscore }}</text>
                    {% else %}
                        {# Left side (4, 5) #}
                        <text x="{{ lx - 8 }}" y="{{ ly - 4 }}" text-anchor="end" fill="#334155" font-size="12" font-weight="600">{{ label }}</text>
                        <text x="{{ lx - 8 }}" y="{{ ly + 11 }}" text-anchor="end" fill="{{ color }}" font-size="13" font-weight="800">{{ dscore }}</text>
                    {% endif %}
                {% endfor %}

                {# ‚îÄ‚îÄ Center average score ‚îÄ‚îÄ #}
                <text x="{{ cx }}" y="{{ cy - 6 }}" text-anchor="middle" fill="#0f172a" font-size="28" font-weight="800">{{ avg }}</text>
                <text x="{{ cx }}" y="{{ cy + 12 }}" text-anchor="middle" fill="#94a3b8" font-size="10" font-weight="600">AVERAGE</text>
            </svg>
        </div>
    </div>

    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê STRENGTHS + IMPROVEMENTS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
        <!-- Strengths -->
        <div class="bg-emerald-50 rounded-2xl border border-emerald-100 p-5">
            <h3 class="text-sm font-bold text-emerald-700 flex items-center gap-2 mb-3">
                <span class="w-6 h-6 bg-emerald-100 rounded-full flex items-center justify-center text-xs">‚úì</span>
                Top Strengths
            </h3>
            <ul class="space-y-2">
                {% for s in feedback.get('top_strengths', []) %}
                <li class="text-sm text-slate-700 leading-relaxed pl-1">‚Ä¢ {{ s }}</li>
                {% endfor %}
                {% if not feedback.get('top_strengths') %}
                <li class="text-sm text-slate-400 italic">Complete the interview to see strengths</li>
                {% endif %}
            </ul>
        </div>
        <!-- Improvements -->
        <div class="bg-amber-50 rounded-2xl border border-amber-100 p-5">
            <h3 class="text-sm font-bold text-amber-700 flex items-center gap-2 mb-3">
                <span class="w-6 h-6 bg-amber-100 rounded-full flex items-center justify-center text-xs">!</span>
                Key Improvements
            </h3>
            <ul class="space-y-2">
                {% for imp in feedback.get('key_improvements', []) %}
                <li class="text-sm text-slate-700 leading-relaxed pl-1">‚Ä¢ {{ imp }}</li>
                {% endfor %}
                {% if not feedback.get('key_improvements') %}
                <li class="text-sm text-slate-400 italic">Complete the interview to see improvements</li>
                {% endif %}
            </ul>
        </div>
    </div>

    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê DETAILED DIMENSION CARDS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <div>
        <h2 class="text-base font-bold text-slate-800 mb-3">Detailed Analysis</h2>
        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
            {% for key, label, color, emoji in dim_meta %}
            {% set dim = dims.get(key, {}) %}
            {% set dscore = dim.get('score', 0)|int %}
            <div class="bg-white rounded-2xl shadow-sm border border-slate-200 p-5 hover:shadow-md transition-shadow">
                <div class="flex items-center gap-3 mb-3">
                    <span class="text-2xl">{{ emoji }}</span>
                    <div class="flex-1">
                        <span class="text-sm font-bold text-slate-700">{{ label }}</span>
                    </div>
                    <span class="text-xl font-black tabular-nums {% if dscore >= 75 %}text-emerald-600{% elif dscore >= 50 %}text-amber-600{% else %}text-red-500{% endif %}">{{ dscore }}</span>
                </div>
                <div class="dim-bar-track mb-3">
                    <div class="dim-bar-fill" style="width:{{ dscore }}%; background:{{ color }};"></div>
                </div>
                <p class="text-xs text-slate-500 leading-relaxed">{{ dim.get('feedback', 'Complete the interview to receive feedback.') }}</p>
                {% if dim.get('tips') %}
                <div class="mt-3 pt-3 border-t border-slate-100">
                    <p class="text-[10px] font-bold text-slate-400 uppercase tracking-wider mb-1.5">Tips</p>
                    {% for tip in dim.get('tips', [])[:2] %}
                    <p class="text-[11px] text-slate-500 leading-relaxed mb-1" style="padding-left:10px; border-left:2px solid {{ color }};">{{ tip }}</p>
                    {% endfor %}
                </div>
                {% endif %}
            </div>
            {% endfor %}
        </div>
    </div>

    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê PER-QUESTION BREAKDOWN ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <div>
        <h2 class="text-base font-bold text-slate-800 mb-3">Question-by-Question</h2>
        <div class="space-y-3">
            {% for pq in feedback.get('per_question_feedback', []) %}
            {% set qs = pq.get('score', 0)|int %}
            <details class="bg-white rounded-2xl shadow-sm border border-slate-200 hover:shadow-md transition-shadow">
                <summary class="flex items-center gap-3 px-5 py-4 cursor-pointer">
                    <div class="q-badge
                        {% if qs >= 75 %}bg-emerald-100 text-emerald-700
                        {% elif qs >= 50 %}bg-amber-100 text-amber-700
                        {% else %}bg-red-100 text-red-700{% endif %}">
                        {{ qs }}
                    </div>
                    <div class="flex-1 min-w-0">
                        <p class="text-sm font-semibold text-slate-700 truncate">{{ pq.get('question', 'Question') }}</p>
                        <p class="text-xs text-slate-400 mt-0.5 truncate">{{ pq.get('answer_summary', '') }}</p>
                    </div>
                    {% if pq.get('star_analysis') %}
                    <div class="hidden sm:flex items-center gap-1 flex-shrink-0">
                        {% for part in ['situation', 'task', 'action', 'result'] %}
                        <span class="text-[9px] font-bold w-5 h-5 rounded flex items-center justify-center
                            {% if pq.star_analysis.get(part) %}bg-emerald-100 text-emerald-600{% else %}bg-slate-100 text-slate-300{% endif %}">
                            {{ part[0]|upper }}
                        </span>
                        {% endfor %}
                    </div>
                    {% endif %}
                    <svg class="chevron w-4 h-4 text-slate-300 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg>
                </summary>
                <div class="px-5 pb-5 border-t border-slate-100 pt-4 space-y-3">
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
                        {% if pq.get('strengths') %}
                        <div class="bg-emerald-50/60 rounded-xl p-3">
                            <p class="text-[11px] font-bold text-emerald-600 mb-1.5">Strengths</p>
                            {% for s in pq.strengths %}
                            <p class="text-xs text-slate-600 leading-relaxed mb-1">+ {{ s }}</p>
                            {% endfor %}
                        </div>
                        {% endif %}
                        {% if pq.get('improvements') %}
                        <div class="bg-amber-50/60 rounded-xl p-3">
                            <p class="text-[11px] font-bold text-amber-600 mb-1.5">Improvements</p>
                            {% for imp in pq.improvements %}
                            <p class="text-xs text-slate-600 leading-relaxed mb-1">‚Üí {{ imp }}</p>
                            {% endfor %}
                        </div>
                        {% endif %}
                    </div>
                    {% if pq.get('sample_answer') %}
                    <div class="bg-slate-50 border border-slate-200 rounded-xl p-4">
                        <p class="text-[11px] font-bold text-indigo-600 mb-1.5">üí° Model Answer</p>
                        <p class="text-xs text-slate-600 leading-relaxed">{{ pq.sample_answer }}</p>
                    </div>
                    {% endif %}
                    {% if pq.get('code_review') %}
                    <div class="bg-slate-50 border border-slate-200 rounded-xl p-4">
                        <p class="text-[11px] font-bold text-slate-700 mb-2">Code Review</p>
                        <div class="grid grid-cols-3 gap-2 text-xs">
                            <div class="bg-white rounded-lg p-2 text-center">
                                <p class="text-[10px] text-slate-400">Correctness</p>
                                <p class="font-semibold text-slate-700">{{ pq.code_review.get('correctness', 'N/A') }}</p>
                            </div>
                            <div class="bg-white rounded-lg p-2 text-center">
                                <p class="text-[10px] text-slate-400">Time</p>
                                <p class="font-semibold text-slate-700">{{ pq.code_review.get('time_complexity', 'N/A') }}</p>
                            </div>
                            <div class="bg-white rounded-lg p-2 text-center">
                                <p class="text-[10px] text-slate-400">Space</p>
                                <p class="font-semibold text-slate-700">{{ pq.code_review.get('space_complexity', 'N/A') }}</p>
                            </div>
                        </div>
                    </div>
                    {% endif %}
                </div>
            </details>
            {% endfor %}
            {% if not feedback.get('per_question_feedback') %}
            <div class="bg-white rounded-2xl shadow-sm border border-slate-200 p-8 text-center">
                <p class="text-sm text-slate-400">No per-question feedback available</p>
                <p class="text-xs text-slate-300 mt-1">Answer at least one question to get detailed analysis</p>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê TRANSCRIPT (collapsed by default) ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <details class="bg-white rounded-2xl shadow-sm border border-slate-200">
        <summary class="flex items-center gap-2 px-5 py-4 cursor-pointer text-sm font-bold text-slate-700 hover:bg-slate-50 rounded-2xl transition">
            <span>üìù</span>
            View Full Transcript ({{ exchanges|length }} exchanges)
            <svg class="chevron w-4 h-4 text-slate-300 ml-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg>
        </summary>
        <div class="px-5 pb-5 border-t border-slate-100 pt-4 space-y-3 max-h-[500px] overflow-y-auto">
            {% for ex in exchanges %}
            <div class="space-y-2">
                <div class="flex gap-2">
                    <div class="w-7 h-7 rounded-full bg-indigo-600 flex items-center justify-center text-white text-[10px] font-bold flex-shrink-0 mt-0.5">P</div>
                    <div class="bg-slate-50 rounded-xl rounded-tl-sm px-3.5 py-2.5 text-xs text-slate-700 leading-relaxed max-w-[85%]">
                        <span class="text-[10px] font-bold text-indigo-500">Q{{ ex.sequence }}</span><br>
                        {{ ex.question_text }}
                    </div>
                </div>
                {% if ex.answer_text %}
                <div class="flex justify-end">
                    <div class="bg-indigo-50 border border-indigo-100 rounded-xl rounded-br-sm px-3.5 py-2.5 text-xs text-slate-700 leading-relaxed max-w-[80%]">
                        {{ ex.answer_text }}
                    </div>
                </div>
                {% endif %}
                {% if ex.code_text %}
                <div class="flex justify-end">
                    <pre class="bg-slate-900 text-emerald-300 rounded-xl px-3.5 py-2.5 text-[11px] overflow-x-auto max-w-[80%]"><code>{{ ex.code_text }}</code></pre>
                </div>
                {% endif %}
            </div>
            {% endfor %}
        </div>
    </details>

    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê ACTIONS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <div class="flex flex-wrap gap-3">
        <a href="{{ url_for('career_services_mock_interviews') }}"
           class="px-6 py-3 bg-gradient-to-r from-indigo-600 to-emerald-500 hover:from-indigo-700 hover:to-emerald-600 text-white font-bold text-sm rounded-xl shadow-lg transition-all flex items-center gap-2">
            ‚Üª Practice Again
        </a>
        <a href="{{ url_for('career_services_mock_interviews') }}"
           class="px-6 py-3 bg-white hover:bg-slate-50 text-slate-700 font-semibold text-sm rounded-xl border border-slate-200 transition flex items-center gap-2">
            ‚Üê Back to Interviews
        </a>
    </div>

</div>

{% endblock %}
