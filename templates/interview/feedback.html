{% extends "dashboard_base.html" %}
{% block title %}Interview Feedback — {{ iv_session.target_role }} — LevelUpX{% endblock %}
{% block page_title %}Interview Feedback{% endblock %}
{% block content %}

<div class="max-w-5xl mx-auto space-y-6">

    <!-- ═══════════ Header with Overall Score ═══════════ -->
    <div class="bg-gradient-to-br from-slate-800 to-slate-900 rounded-2xl p-6 text-white">
        <div class="flex flex-col sm:flex-row items-start sm:items-center gap-6">
            <!-- Score Circle -->
            <div class="relative flex-shrink-0">
                {% set score = feedback.get('overall_score', 0)|int %}
                {% set pct = score * 3.6 %}
                {% if score >= 75 %}{% set score_color = '#10b981' %}{% set score_bg = 'emerald' %}
                {% elif score >= 50 %}{% set score_color = '#f59e0b' %}{% set score_bg = 'amber' %}
                {% else %}{% set score_color = '#ef4444' %}{% set score_bg = 'red' %}{% endif %}
                <div class="w-24 h-24 rounded-full flex items-center justify-center"
                     style="background: conic-gradient({{ score_color }} {{ pct }}deg, rgba(255,255,255,0.1) 0deg);">
                    <div class="w-20 h-20 rounded-full bg-slate-800 flex items-center justify-center">
                        <span class="text-3xl font-black" style="color: {{ score_color }}">{{ score }}</span>
                    </div>
                </div>
            </div>
            <!-- Info -->
            <div class="flex-1">
                <h1 class="text-xl font-bold">{{ iv_session.target_role }}</h1>
                <div class="flex flex-wrap gap-2 mt-2">
                    <span class="text-[11px] bg-white/10 px-2.5 py-0.5 rounded-full font-medium">{{ iv_session.interview_type|capitalize }}</span>
                    <span class="text-[11px] bg-white/10 px-2.5 py-0.5 rounded-full font-medium">{{ iv_session.difficulty|capitalize }}</span>
                    <span class="text-[11px] bg-white/10 px-2.5 py-0.5 rounded-full font-medium">{{ iv_session.duration_minutes }} min</span>
                    <span class="text-[11px] bg-white/10 px-2.5 py-0.5 rounded-full font-medium">{{ iv_session.persona|capitalize }} Persona</span>
                    {% if iv_session.started_at %}
                    <span class="text-[11px] bg-white/10 px-2.5 py-0.5 rounded-full font-medium">{{ iv_session.started_at.strftime('%d %b %Y') }}</span>
                    {% endif %}
                </div>
                <p class="text-sm text-white/60 mt-3 leading-relaxed">{{ feedback.get('summary', 'Interview completed.') }}</p>
            </div>
        </div>
    </div>

    <!-- ═══════════ Radar Chart ═══════════ -->
    <div class="bg-white rounded-2xl shadow-sm border border-slate-200 p-5">
        <h2 class="text-sm font-bold text-slate-800 mb-3 text-center">Performance Overview</h2>
        <div class="flex justify-center">
            <canvas id="radar-chart" width="380" height="380" class="max-w-full"></canvas>
        </div>
    </div>

    <script>
    (function() {
        const canvas = document.getElementById('radar-chart');
        if (!canvas) return;
        const ctx = canvas.getContext('2d');
        const W = canvas.width, H = canvas.height;
        const cx = W / 2, cy = H / 2;
        const R = Math.min(cx, cy) - 50;

        const labels = ['Communication', 'Content Depth', 'Structure', 'Technical', 'Problem Solving', 'Confidence'];
        const scores = [
            {{ dims.get('communication', {}).get('score', 0)|int }},
            {{ dims.get('content_depth', {}).get('score', 0)|int }},
            {{ dims.get('structure', {}).get('score', 0)|int }},
            {{ dims.get('technical_accuracy', {}).get('score', 0)|int }},
            {{ dims.get('problem_solving', {}).get('score', 0)|int }},
            {{ dims.get('confidence_presence', {}).get('score', 0)|int }}
        ];
        const n = labels.length;
        const step = (2 * Math.PI) / n;

        function polar(angle, r) {
            return [cx + r * Math.cos(angle - Math.PI / 2), cy + r * Math.sin(angle - Math.PI / 2)];
        }

        /* grid rings at 20, 40, 60, 80, 100 */
        for (let ring = 1; ring <= 5; ring++) {
            const r = (R * ring) / 5;
            ctx.beginPath();
            for (let i = 0; i <= n; i++) {
                const [x, y] = polar(i * step, r);
                i === 0 ? ctx.moveTo(x, y) : ctx.lineTo(x, y);
            }
            ctx.closePath();
            ctx.strokeStyle = 'rgba(148,163,184,0.25)';
            ctx.lineWidth = 1;
            ctx.stroke();

            /* ring labels */
            if (ring % 2 === 0) {
                const val = ring * 20;
                ctx.fillStyle = 'rgba(148,163,184,0.5)';
                ctx.font = '10px Inter, system-ui, sans-serif';
                ctx.fillText(val, cx + 3, cy - r + 10);
            }
        }

        /* axis lines */
        for (let i = 0; i < n; i++) {
            const [x, y] = polar(i * step, R);
            ctx.beginPath();
            ctx.moveTo(cx, cy);
            ctx.lineTo(x, y);
            ctx.strokeStyle = 'rgba(148,163,184,0.2)';
            ctx.lineWidth = 1;
            ctx.stroke();
        }

        /* score polygon */
        ctx.beginPath();
        for (let i = 0; i < n; i++) {
            const r = (R * Math.min(scores[i], 100)) / 100;
            const [x, y] = polar(i * step, r);
            i === 0 ? ctx.moveTo(x, y) : ctx.lineTo(x, y);
        }
        ctx.closePath();
        ctx.fillStyle = 'rgba(99,102,241,0.15)';
        ctx.fill();
        ctx.strokeStyle = 'rgba(99,102,241,0.7)';
        ctx.lineWidth = 2;
        ctx.stroke();

        /* score dots */
        for (let i = 0; i < n; i++) {
            const r = (R * Math.min(scores[i], 100)) / 100;
            const [x, y] = polar(i * step, r);
            ctx.beginPath();
            ctx.arc(x, y, 4, 0, 2 * Math.PI);
            ctx.fillStyle = '#6366f1';
            ctx.fill();
            ctx.strokeStyle = '#fff';
            ctx.lineWidth = 2;
            ctx.stroke();
        }

        /* labels */
        ctx.fillStyle = '#334155';
        ctx.font = '11px Inter, system-ui, sans-serif';
        ctx.textAlign = 'center';
        for (let i = 0; i < n; i++) {
            const [x, y] = polar(i * step, R + 25);
            const label = labels[i];
            ctx.textBaseline = y < cy ? 'bottom' : y > cy + 5 ? 'top' : 'middle';
            if (Math.abs(x - cx) < 10) ctx.textAlign = 'center';
            else if (x < cx) ctx.textAlign = 'right';
            else ctx.textAlign = 'left';
            ctx.fillText(label, x, y);

            /* score value next to label */
            ctx.fillStyle = '#6366f1';
            ctx.font = 'bold 11px Inter, system-ui, sans-serif';
            const offset = ctx.textAlign === 'left' ? 4 : ctx.textAlign === 'right' ? -4 : 0;
            ctx.fillText(scores[i], x + offset, y + 14);
            ctx.fillStyle = '#334155';
            ctx.font = '11px Inter, system-ui, sans-serif';
        }
    })();
    </script>

    <!-- ═══════════ Top Strengths & Improvements ═══════════ -->
    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
        <div class="bg-white rounded-2xl shadow-sm border border-slate-200 p-5">
            <h3 class="text-sm font-bold text-emerald-700 flex items-center gap-2 mb-3">
                <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.857-9.809a.75.75 0 00-1.214-.882l-3.483 4.79-1.88-1.88a.75.75 0 10-1.06 1.061l2.5 2.5a.75.75 0 001.137-.089l4-5.5z" clip-rule="evenodd"/></svg>
                Top Strengths
            </h3>
            <ul class="space-y-2">
                {% for s in feedback.get('top_strengths', []) %}
                <li class="flex gap-2 text-sm text-slate-600">
                    <span class="text-emerald-500 flex-shrink-0 mt-0.5">+</span>
                    {{ s }}
                </li>
                {% endfor %}
                {% if not feedback.get('top_strengths') %}
                <li class="text-sm text-slate-400">No data available</li>
                {% endif %}
            </ul>
        </div>
        <div class="bg-white rounded-2xl shadow-sm border border-slate-200 p-5">
            <h3 class="text-sm font-bold text-amber-700 flex items-center gap-2 mb-3">
                <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M8.485 2.495c.673-1.167 2.357-1.167 3.03 0l6.28 10.875c.673 1.167-.168 2.625-1.516 2.625H3.72c-1.347 0-2.189-1.458-1.515-2.625L8.485 2.495zM10 6a.75.75 0 01.75.75v3.5a.75.75 0 01-1.5 0v-3.5A.75.75 0 0110 6zm0 9a1 1 0 100-2 1 1 0 000 2z" clip-rule="evenodd"/></svg>
                Key Improvements
            </h3>
            <ul class="space-y-2">
                {% for imp in feedback.get('key_improvements', []) %}
                <li class="flex gap-2 text-sm text-slate-600">
                    <span class="text-amber-500 flex-shrink-0 mt-0.5">!</span>
                    {{ imp }}
                </li>
                {% endfor %}
                {% if not feedback.get('key_improvements') %}
                <li class="text-sm text-slate-400">No data available</li>
                {% endif %}
            </ul>
        </div>
    </div>

    <!-- ═══════════ Dimension Scores (6 cards) ═══════════ -->
    <div>
        <h2 class="text-base font-bold text-slate-800 mb-3">Scoring Dimensions</h2>
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
            {% set dims = feedback.get('dimensions', {}) %}
            {% set dim_labels = {
                'communication': ('Communication', 'brand'),
                'content_depth': ('Content Depth', 'indigo'),
                'structure': ('Structure & STAR', 'emerald'),
                'technical_accuracy': ('Technical Accuracy', 'violet'),
                'problem_solving': ('Problem Solving', 'amber'),
                'confidence_presence': ('Confidence & Presence', 'rose')
            } %}
            {% for key, (label, color) in dim_labels.items() %}
            {% set dim = dims.get(key, {}) %}
            {% set dscore = dim.get('score', 0)|int %}
            <div class="bg-white rounded-2xl shadow-sm border border-slate-200 p-4">
                <div class="flex items-center justify-between mb-2">
                    <span class="text-xs font-bold text-slate-700">{{ label }}</span>
                    <span class="text-sm font-black {% if dscore >= 75 %}text-emerald-600{% elif dscore >= 50 %}text-amber-600{% else %}text-red-600{% endif %}">{{ dscore }}</span>
                </div>
                <!-- Score bar -->
                <div class="w-full bg-slate-100 rounded-full h-2 mb-2">
                    <div class="h-2 rounded-full transition-all duration-700
                        {% if dscore >= 75 %}bg-emerald-500{% elif dscore >= 50 %}bg-amber-500{% else %}bg-red-500{% endif %}"
                        style="width: {{ dscore }}%"></div>
                </div>
                <p class="text-xs text-slate-500 leading-relaxed">{{ dim.get('feedback', 'No feedback available.') }}</p>
                {% if dim.get('tips') %}
                <ul class="mt-2 space-y-1">
                    {% for tip in dim.get('tips', [])[:2] %}
                    <li class="text-[11px] text-slate-400 flex gap-1">
                        <span class="text-brand-500 flex-shrink-0">&#8250;</span> {{ tip }}
                    </li>
                    {% endfor %}
                </ul>
                {% endif %}
            </div>
            {% endfor %}
        </div>
    </div>

    <!-- ═══════════ Per-Question Breakdown ═══════════ -->
    <div>
        <h2 class="text-base font-bold text-slate-800 mb-3">Question-by-Question Analysis</h2>
        <div class="space-y-3">
            {% for pq in feedback.get('per_question_feedback', []) %}
            <details class="bg-white rounded-2xl shadow-sm border border-slate-200 group">
                <summary class="flex items-center gap-3 px-5 py-4 cursor-pointer list-none">
                    <!-- Score badge -->
                    {% set qs = pq.get('score', 0)|int %}
                    <div class="w-9 h-9 rounded-full flex items-center justify-center text-xs font-bold flex-shrink-0
                        {% if qs >= 75 %}bg-emerald-100 text-emerald-700
                        {% elif qs >= 50 %}bg-amber-100 text-amber-700
                        {% else %}bg-red-100 text-red-700{% endif %}">
                        {{ qs }}
                    </div>
                    <div class="flex-1 min-w-0">
                        <p class="text-sm font-semibold text-slate-700 truncate">{{ pq.get('question', 'Question') }}</p>
                        <p class="text-xs text-slate-400 mt-0.5 truncate">{{ pq.get('answer_summary', '') }}</p>
                    </div>
                    <!-- STAR indicators (behavioral) -->
                    {% if pq.get('star_analysis') %}
                    <div class="hidden sm:flex items-center gap-1 flex-shrink-0">
                        {% for part in ['situation', 'task', 'action', 'result'] %}
                        <span class="text-[9px] font-bold px-1.5 py-0.5 rounded
                            {% if pq.star_analysis.get(part) %}bg-emerald-100 text-emerald-600{% else %}bg-slate-100 text-slate-300{% endif %}">
                            {{ part[0]|upper }}
                        </span>
                        {% endfor %}
                    </div>
                    {% endif %}
                    <svg class="w-4 h-4 text-slate-300 transition-transform group-open:rotate-180 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg>
                </summary>
                <div class="px-5 pb-5 border-t border-slate-100 pt-4 space-y-3">
                    <!-- Strengths & Improvements -->
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
                        {% if pq.get('strengths') %}
                        <div>
                            <p class="text-[11px] font-bold text-emerald-600 mb-1">Strengths</p>
                            <ul class="space-y-1">
                                {% for s in pq.strengths %}
                                <li class="text-xs text-slate-600 flex gap-1"><span class="text-emerald-400">+</span> {{ s }}</li>
                                {% endfor %}
                            </ul>
                        </div>
                        {% endif %}
                        {% if pq.get('improvements') %}
                        <div>
                            <p class="text-[11px] font-bold text-amber-600 mb-1">Improvements</p>
                            <ul class="space-y-1">
                                {% for imp in pq.improvements %}
                                <li class="text-xs text-slate-600 flex gap-1"><span class="text-amber-400">!</span> {{ imp }}</li>
                                {% endfor %}
                            </ul>
                        </div>
                        {% endif %}
                    </div>
                    <!-- Sample Answer -->
                    {% if pq.get('sample_answer') %}
                    <div class="bg-emerald-50 border border-emerald-100 rounded-xl p-3">
                        <p class="text-[11px] font-bold text-emerald-700 mb-1">Model Answer</p>
                        <p class="text-xs text-slate-600 leading-relaxed">{{ pq.sample_answer }}</p>
                    </div>
                    {% endif %}
                    <!-- Code Review -->
                    {% if pq.get('code_review') %}
                    <div class="bg-slate-50 border border-slate-100 rounded-xl p-3">
                        <p class="text-[11px] font-bold text-slate-700 mb-2">Code Review</p>
                        <div class="grid grid-cols-2 gap-2 text-xs">
                            <div><span class="text-slate-400">Correctness:</span> <span class="font-medium text-slate-700">{{ pq.code_review.get('correctness', 'N/A') }}</span></div>
                            <div><span class="text-slate-400">Time:</span> <span class="font-medium text-slate-700">{{ pq.code_review.get('time_complexity', 'N/A') }}</span></div>
                            <div><span class="text-slate-400">Space:</span> <span class="font-medium text-slate-700">{{ pq.code_review.get('space_complexity', 'N/A') }}</span></div>
                        </div>
                        {% if pq.code_review.get('optimal_solution') %}
                        <div class="mt-2">
                            <p class="text-[10px] font-bold text-slate-500 mb-1">Optimal Solution</p>
                            <pre class="bg-slate-900 text-emerald-300 p-2 rounded-lg text-[11px] overflow-x-auto"><code>{{ pq.code_review.optimal_solution }}</code></pre>
                        </div>
                        {% endif %}
                    </div>
                    {% endif %}
                </div>
            </details>
            {% endfor %}
            {% if not feedback.get('per_question_feedback') %}
            <div class="bg-white rounded-2xl shadow-sm border border-slate-200 p-6 text-center">
                <p class="text-sm text-slate-400">No per-question feedback available</p>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- ═══════════ Transcript (collapsible) ═══════════ -->
    <details class="bg-white rounded-2xl shadow-sm border border-slate-200">
        <summary class="flex items-center gap-2 px-5 py-4 cursor-pointer text-sm font-bold text-slate-700 list-none">
            <svg class="w-4 h-4 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z"/></svg>
            View Full Transcript
            <svg class="w-4 h-4 text-slate-300 ml-auto transition-transform group-open:rotate-180" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg>
        </summary>
        <div class="px-5 pb-5 border-t border-slate-100 pt-4 space-y-3 max-h-96 overflow-y-auto">
            {% for ex in exchanges %}
            <div class="space-y-2">
                <div class="flex gap-2">
                    <div class="w-6 h-6 rounded-full bg-brand-500 flex items-center justify-center text-white text-[9px] font-bold flex-shrink-0 mt-0.5">A</div>
                    <div class="bg-slate-50 rounded-xl px-3 py-2 text-xs text-slate-700 leading-relaxed">
                        <span class="text-[10px] font-bold text-slate-400">Q{{ ex.sequence }}</span><br>
                        {{ ex.question_text }}
                    </div>
                </div>
                {% if ex.answer_text %}
                <div class="flex justify-end">
                    <div class="bg-brand-50 rounded-xl px-3 py-2 text-xs text-brand-700 leading-relaxed max-w-[80%]">
                        {{ ex.answer_text }}
                    </div>
                </div>
                {% endif %}
                {% if ex.code_text %}
                <div class="flex justify-end">
                    <pre class="bg-slate-900 text-emerald-300 rounded-xl px-3 py-2 text-[11px] overflow-x-auto max-w-[80%]"><code>{{ ex.code_text }}</code></pre>
                </div>
                {% endif %}
            </div>
            {% endfor %}
        </div>
    </details>

    <!-- ═══════════ Actions ═══════════ -->
    <div class="flex flex-wrap gap-3 pb-6">
        <a href="{{ url_for('career_services_mock_interviews') }}"
           class="px-6 py-3 bg-gradient-to-r from-brand-600 to-emerald-500 hover:from-brand-700 hover:to-emerald-600 text-white font-bold text-sm rounded-xl shadow-lg shadow-brand-500/25 transition flex items-center gap-2">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/></svg>
            Practice Again
        </a>
        <a href="{{ url_for('career_services_mock_interviews') }}"
           class="px-6 py-3 bg-white hover:bg-slate-50 text-slate-700 font-semibold text-sm rounded-xl border border-slate-200 transition flex items-center gap-2">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-4 0a1 1 0 01-1-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 01-1 1h-2z"/></svg>
            Back to Interviews
        </a>
    </div>

</div>

{% endblock %}
