<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ iv_session.target_role }} Interview — LevelUpX</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/output.css') }}">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { background: #020617; color: #e2e8f0; font-family: 'Inter', sans-serif; overflow: hidden; height: 100vh; margin: 0; }
        .room-layout { display: flex; flex-direction: column; height: 100vh; }
        .video-grid { display: flex; flex: 1; min-height: 0; }
        .video-panel { flex: 1; position: relative; display: flex; align-items: center; justify-content: center; overflow: hidden; }

        #avatar-frame { width: 280px; height: 280px; border-radius: 50%; overflow: hidden; position: relative; box-shadow: 0 0 60px rgba(99,102,241,0.15); animation: avatar-idle 6s ease-in-out infinite; transition: filter 300ms ease, transform 300ms ease; }
        @keyframes avatar-idle { 0%,100%{transform:scale(1) translateY(0) rotate(0deg)} 25%{transform:scale(1.006) translateY(-1.5px) rotate(0.3deg)} 50%{transform:scale(1) translateY(0) rotate(-0.2deg)} 75%{transform:scale(0.994) translateY(1.5px) rotate(0.1deg)} }

        /* Avatar mouth & blink overlays REMOVED — SVG has its own face.
           Speaking feedback via speaking-tilt + speaking-glow on #avatar-frame. */

        /* Expression classes applied to #avatar-frame */
        #avatar-frame.thinking { transform:rotate(2.5deg) translateY(-1px); filter:brightness(0.95) saturate(0.95); animation: think-sway 3s ease-in-out infinite; }
        @keyframes think-sway { 0%,100%{transform:rotate(2.5deg) translateY(-1px)} 50%{transform:rotate(1deg) translateY(1px)} }
        #avatar-frame.smile { transform:translateY(-2px) scale(1.01); filter:brightness(1.05); }
        #avatar-frame.nod { animation: nod 400ms ease-in-out; }
        @keyframes nod { 0%,100%{transform:translateY(0)} 50%{transform:translateY(-4px) rotate(-0.5deg)} }

        #webcam-video { width:100%; height:100%; object-fit:cover; transform:scaleX(-1); }

        .name-plate { position:absolute; bottom:12px; left:12px; background:rgba(0,0,0,0.6); backdrop-filter:blur(8px); padding:4px 12px; border-radius:6px; display:flex; align-items:center; gap:8px; }
        .name-plate span { font-size:12px; font-weight:600; color:white; }

        .speaking-wave { display:flex; align-items:flex-end; gap:2px; height:14px; }
        .speaking-wave .bar { width:3px; background:#10b981; border-radius:2px; }

        /* bottom-panel removed — video grid takes full height */

        .control-btn { width:48px; height:48px; border-radius:50%; display:flex; align-items:center; justify-content:center; background:#334155; color:white; transition:all 150ms; border:none; cursor:pointer; }
        .control-btn:hover { background:#475569; }
        .control-btn.active { background:#10b981; animation:mic-pulse 1.5s ease-out infinite; }
        .control-btn.muted { background:#ef4444; }
        .control-btn.muted:hover { background:#dc2626; }
        .control-btn.off { background:#1e293b; color:#475569; }
        .control-btn.error-state { background:#78350f; color:#fbbf24; animation:none; }
        @keyframes mic-pulse { 0%{box-shadow:0 0 0 0 rgba(16,185,129,0.4)} 70%{box-shadow:0 0 0 12px rgba(16,185,129,0)} 100%{box-shadow:0 0 0 0 rgba(16,185,129,0)} }

        /* Speaking animations for avatar */
        #avatar-frame.speaking-tilt { animation: speak-tilt 4s ease-in-out infinite; }
        @keyframes speak-tilt { 0%,100%{transform:rotate(0deg)} 25%{transform:rotate(1.5deg) translateY(-1px)} 75%{transform:rotate(-1deg) translateY(0.5px)} }
        #avatar-frame.speaking-glow { box-shadow: 0 0 40px rgba(99,102,241,0.3), 0 0 80px rgba(99,102,241,0.1); }

        /* Ending interview overlay */
        .ending-overlay { position:fixed; inset:0; z-index:100; background:rgba(2,6,23,0.95); display:flex; flex-direction:column; align-items:center; justify-content:center; gap:16px; }
        .ending-spinner { width:48px; height:48px; border:4px solid rgba(99,102,241,0.2); border-top-color:#6366f1; border-radius:50%; animation:ending-spin 1s linear infinite; }
        @keyframes ending-spin { to{transform:rotate(360deg)} }
        .ending-msg { color:#e2e8f0; font-size:18px; font-weight:600; }
        .ending-sub { color:#64748b; font-size:13px; }

        /* Speaking wave animation */
        @keyframes eq1 { 0%,100%{height:4px} 50%{height:14px} }
        @keyframes eq2 { 0%,100%{height:8px} 50%{height:10px} }
        @keyframes eq3 { 0%,100%{height:10px} 50%{height:5px} }
        @keyframes eq4 { 0%,100%{height:5px} 50%{height:12px} }
        .wave-1 { animation:eq1 0.8s ease-in-out infinite; }
        .wave-2 { animation:eq2 0.6s ease-in-out infinite 0.1s; }
        .wave-3 { animation:eq3 0.7s ease-in-out infinite 0.2s; }
        .wave-4 { animation:eq4 0.5s ease-in-out infinite 0.15s; }
        .wave-5 { animation:eq3 0.65s ease-in-out infinite 0.05s; }

        /* Typing dots */
        .typing-dots span { display:inline-block; width:6px; height:6px; border-radius:50%; background:#64748b; animation:typing 1.2s ease-in-out infinite; }
        .typing-dots span:nth-child(2) { animation-delay:0.2s; }
        .typing-dots span:nth-child(3) { animation-delay:0.4s; }
        @keyframes typing { 0%,80%,100%{transform:translateY(0)} 40%{transform:translateY(-6px)} }

        /* caption-bar removed */

        /* ═══ Apple Music-style lyrics subtitle ═══
           Depth-of-field illusion: active line is crisp + bright,
           older lines progressively dim + blur + shrink upward.
           Uses cubic-bezier(0.42,0,0.58,1) = CSS ease-in-out. */
        #avatar-subtitle {
            overflow:hidden; white-space:normal; max-height:160px;
            display:flex; flex-direction:column; justify-content:flex-end;
            /* Top/bottom edge fade via mask-image */
            -webkit-mask-image: linear-gradient(to bottom, transparent 0%, black 20%, black 85%, transparent 100%);
            mask-image: linear-gradient(to bottom, transparent 0%, black 20%, black 85%, transparent 100%);
        }
        #avatar-subtitle .lyric-line {
            text-align:center; line-height:1.55; padding:3px 0; white-space:normal; word-break:break-word;
            /* Start hidden — JS applies state classes */
            opacity:0; font-size:13px; font-weight:400; color:rgba(255,255,255,0.15);
            transform: translateY(6px) scale(0.94);
            filter: blur(3px);
            transition: opacity 0.5s cubic-bezier(0.42,0,0.58,1),
                        transform 0.5s cubic-bezier(0.42,0,0.58,1),
                        filter 0.5s cubic-bezier(0.42,0,0.58,1),
                        font-weight 0.3s ease;
        }
        /* ── Gradient states ── distance 0 = current, 1..4 = past ── */
        #avatar-subtitle .lyric-line[data-dist="0"] {
            opacity:1; color:#fff; font-weight:700; font-size:14px;
            transform: translateY(0) scale(1); filter: blur(0);
        }
        #avatar-subtitle .lyric-line[data-dist="1"] {
            opacity:0.55; color:rgba(255,255,255,0.65); font-weight:500; font-size:13px;
            transform: translateY(0) scale(0.97); filter: blur(0.5px);
        }
        #avatar-subtitle .lyric-line[data-dist="2"] {
            opacity:0.3; color:rgba(255,255,255,0.4); font-weight:400; font-size:13px;
            transform: translateY(0) scale(0.95); filter: blur(1.5px);
        }
        #avatar-subtitle .lyric-line[data-dist="3"] {
            opacity:0.15; color:rgba(255,255,255,0.2); font-weight:400; font-size:12px;
            transform: translateY(0) scale(0.93); filter: blur(2.5px);
        }
        #avatar-subtitle .lyric-line[data-dist="4"] {
            opacity:0.06; color:rgba(255,255,255,0.1); font-weight:300; font-size:12px;
            transform: translateY(-2px) scale(0.91); filter: blur(4px);
        }
        #avatar-subtitle .lyric-line.exiting {
            opacity:0 !important; transform: translateY(-10px) scale(0.88) !important; filter: blur(6px) !important;
            transition: all 0.6s cubic-bezier(0.42,0,0.58,1);
        }

        /* Type modal */
        #type-modal { position:fixed; bottom:56px; left:50%; transform:translateX(-50%); width:90%; max-width:600px; z-index:50; }

        /* Custom scrollbar for dark theme */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #475569; }

        /* Responsive */
        @media (max-width:768px) {
            .video-grid { flex-direction:column; }
            #avatar-frame { width:180px; height:180px; }
            .control-btn { width:40px; height:40px; }
        }
    </style>
</head>
<body>
    <div class="room-layout">

        <!-- ============================================================
             LAYER 1: TOP BAR
             ============================================================ -->
        <header id="top-bar" class="h-12 bg-slate-900/95 backdrop-blur flex items-center px-4 gap-3 fixed top-0 left-0 right-0 z-40 border-b border-white/5">
            <!-- Left cluster -->
            <div class="flex items-center gap-3">
                <!-- Timer -->
                <div id="timer-display" class="flex items-center gap-1.5 text-sm text-slate-300">
                    <svg class="w-4 h-4 text-slate-400" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6h4.5m4.5 0a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z"/>
                    </svg>
                    <span id="timer-text" class="font-semibold tabular-nums">{{ iv_session.duration_minutes }}:00</span>
                </div>

                <!-- Divider -->
                <div class="w-px h-5 bg-white/10"></div>

                <!-- Badges -->
                <span class="text-[10px] font-bold uppercase tracking-wider bg-indigo-500/20 text-indigo-300 px-2 py-0.5 rounded-full">{{ iv_session.interview_type }}</span>
                <span class="text-[10px] font-bold uppercase tracking-wider bg-amber-500/15 text-amber-300 px-2 py-0.5 rounded-full">{{ iv_session.difficulty }}</span>
            </div>

            <!-- Center: role title -->
            <div class="flex-1 text-center">
                <h1 class="text-sm font-semibold text-white truncate">{{ iv_session.target_role }}</h1>
            </div>

            <!-- Right: End Call -->
            <button id="end-call-btn" class="flex items-center gap-2 bg-red-500 hover:bg-red-600 text-white text-xs font-semibold px-4 py-1.5 rounded-full transition-colors">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 3.75 18 6m0 0 2.25 2.25M18 6l2.25-2.25M18 6l-2.25 2.25m1.5 13.5c-8.284 0-15-6.716-15-15V4.5A2.25 2.25 0 0 1 6.75 2.25h1.372c.516 0 .966.351 1.091.852l1.106 4.423c.11.44-.054.902-.417 1.173l-1.293.97a1.062 1.062 0 0 0-.38 1.21 12.035 12.035 0 0 0 7.143 7.143c.441.162.928-.004 1.21-.38l.97-1.293a1.125 1.125 0 0 1 1.173-.417l4.423 1.106c.5.125.852.575.852 1.091v1.372c0 1.243-1.007 2.25-2.25 2.25h-.75Z"/>
                </svg>
                End Call
            </button>
        </header>


        <!-- ============================================================
             LAYER 2: VIDEO AREA
             ============================================================ -->
        <div class="video-grid" style="margin-top:48px;">

            <!-- LEFT: AI Interviewer Panel -->
            <div class="video-panel bg-gradient-to-br from-slate-900 via-indigo-950/30 to-slate-900">
                <!-- Avatar -->
                <div id="avatar-frame">
                    <img id="avatar-photo" src="/static/img/priya-avatar.jpg" alt="AI Interviewer" class="w-full h-full object-cover">
                </div>

                <!-- Subtitle overlay — shows Priya's spoken text while she speaks -->
                <div id="avatar-subtitle"
                     style="display:none; position:absolute; bottom:44px; left:10px; right:10px;
                            background:rgba(0,0,0,0.55); backdrop-filter:blur(12px);
                            border-radius:14px; padding:14px 20px;
                            color:white; line-height:1.5; max-height:160px;
                            opacity:0; transition:opacity 0.5s cubic-bezier(0.42,0,0.58,1); pointer-events:none;
                            overflow:hidden; z-index:10;">
                </div>

                <!-- AI Name Plate -->
                <div class="name-plate">
                    <span>Priya &middot; {{ iv_session.persona }} Interviewer</span>
                    <div id="ai-speaking-wave" class="speaking-wave hidden">
                        <div class="bar wave-1"></div>
                        <div class="bar wave-2"></div>
                        <div class="bar wave-3"></div>
                        <div class="bar wave-4"></div>
                        <div class="bar wave-5"></div>
                    </div>
                </div>

                <!-- Not recording indicator -->
                <div class="absolute top-3 right-3 flex items-center gap-1.5 text-[10px] text-slate-500">
                    <svg class="w-3 h-3" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M16.5 10.5V6.75a4.5 4.5 0 1 0-9 0v3.75m-.75 11.25h10.5a2.25 2.25 0 0 0 2.25-2.25v-6.75a2.25 2.25 0 0 0-2.25-2.25H6.75a2.25 2.25 0 0 0-2.25 2.25v6.75a2.25 2.25 0 0 0 2.25 2.25Z"/>
                    </svg>
                    Not recording
                </div>
            </div>

            <!-- RIGHT: Candidate Webcam Panel -->
            <div class="video-panel bg-slate-800">
                <!-- Live webcam -->
                <video id="webcam-video" autoplay muted playsinline></video>

                <!-- Fallback when camera is off -->
                <div id="webcam-fallback" class="hidden flex flex-col items-center justify-center gap-3">
                    <div class="w-24 h-24 rounded-full bg-slate-700 flex items-center justify-center">
                        <span class="text-3xl font-bold text-slate-300">{{ (user.first_name or "Y")[0] | upper }}</span>
                    </div>
                    <span class="text-xs text-slate-500">Camera off</span>
                </div>

                <!-- User Name Plate -->
                <div class="name-plate">
                    <span>{{ user.first_name or "You" }}</span>
                    <div id="user-speaking-wave" class="speaking-wave hidden">
                        <div class="bar wave-1"></div>
                        <div class="bar wave-2"></div>
                        <div class="bar wave-3"></div>
                        <div class="bar wave-4"></div>
                        <div class="bar wave-5"></div>
                    </div>
                </div>
            </div>
        </div>


        <!-- Bottom panel removed — conversation happens via voice + subtitle overlay -->
        <!-- Hidden containers for JS compatibility (no visual presence) -->
        <div id="bottom-panel" class="hidden">
            <div id="transcript-messages"></div>
            <div id="ai-typing-indicator" class="hidden"></div>
            <div id="tab-code" class="hidden">
                <div id="monaco-container"></div>
            </div>
        </div>


        <!-- ============================================================
             LAYER 5: CONTROL BAR
             ============================================================ -->
        <div id="control-bar" class="h-14 bg-slate-900/95 backdrop-blur flex items-center justify-center gap-4 px-4 border-t border-white/5 flex-shrink-0">
            <!-- Mic -->
            <button id="mic-btn" class="control-btn muted" title="Toggle microphone">
                <svg id="mic-icon-on" class="w-5 h-5 hidden" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 18.75a6 6 0 0 0 6-6v-1.5m-6 7.5a6 6 0 0 1-6-6v-1.5m6 7.5v3.75m-3.75 0h7.5M12 15.75a3 3 0 0 1-3-3V4.5a3 3 0 1 1 6 0v8.25a3 3 0 0 1-3 3Z"/>
                </svg>
                <svg id="mic-icon-off" class="w-5 h-5" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 18.75a6 6 0 0 0 6-6v-1.5m-6 7.5a6 6 0 0 1-6-6v-1.5m6 7.5v3.75m-3.75 0h7.5M12 15.75a3 3 0 0 1-3-3V4.5a3 3 0 1 1 6 0v8.25a3 3 0 0 1-3 3Z"/>
                    <line x1="3" y1="3" x2="21" y2="21" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                </svg>
            </button>

            <!-- Camera -->
            <button id="cam-btn" class="control-btn" title="Toggle camera">
                <svg id="cam-icon-on" class="w-5 h-5" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" d="m15.75 10.5 4.72-4.72a.75.75 0 0 1 1.28.53v11.38a.75.75 0 0 1-1.28.53l-4.72-4.72M4.5 18.75h9a2.25 2.25 0 0 0 2.25-2.25v-9a2.25 2.25 0 0 0-2.25-2.25h-9A2.25 2.25 0 0 0 2.25 7.5v9a2.25 2.25 0 0 0 2.25 2.25Z"/>
                </svg>
                <svg id="cam-icon-off" class="w-5 h-5 hidden" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" d="m15.75 10.5 4.72-4.72a.75.75 0 0 1 1.28.53v11.38a.75.75 0 0 1-1.28.53l-4.72-4.72M4.5 18.75h9a2.25 2.25 0 0 0 2.25-2.25v-9a2.25 2.25 0 0 0-2.25-2.25h-9A2.25 2.25 0 0 0 2.25 7.5v9a2.25 2.25 0 0 0 2.25 2.25Z"/>
                    <line x1="2" y1="2" x2="22" y2="22" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                </svg>
            </button>

            <!-- Divider -->
            <div class="w-px h-7 bg-white/10"></div>

            <!-- Type -->
            <button id="type-btn" class="control-btn" title="Type your answer">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M6.75 7.5h10.5m-10.5 3h10.5M6.75 14.25h4.5m-1.774 5.59c-1.146.04-2.296.048-3.451.024a.627.627 0 0 1-.601-.623V4.262c0-.34.27-.62.608-.623a48.855 48.855 0 0 1 10.118.37.624.624 0 0 1 .535.617v1.124"/>
                </svg>
            </button>

            <!-- Skip -->
            <button id="skip-btn" class="control-btn" title="Skip question">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M3 8.689c0-.864.933-1.406 1.683-.977l7.108 4.061a1.125 1.125 0 0 1 0 1.954l-7.108 4.061A1.125 1.125 0 0 1 3 16.811V8.69ZM12.75 8.689c0-.864.933-1.406 1.683-.977l7.108 4.061a1.125 1.125 0 0 1 0 1.954l-7.108 4.061a1.125 1.125 0 0 1-1.683-.977V8.69Z"/>
                </svg>
            </button>
        </div>

    </div><!-- /.room-layout -->


    <!-- ================================================================
         TYPE MODAL (hidden overlay)
         ================================================================ -->
    <div id="type-modal" class="hidden">
        <div class="bg-slate-800 border border-white/10 rounded-2xl shadow-2xl shadow-black/40 p-4">
            <div class="flex items-center justify-between mb-3">
                <span class="text-xs font-semibold text-slate-400 uppercase tracking-wider">Type your response</span>
                <button id="type-modal-close" class="text-slate-500 hover:text-white transition-colors">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M6 18 18 6M6 6l12 12"/>
                    </svg>
                </button>
            </div>
            <textarea id="type-input" class="w-full bg-slate-900 text-slate-200 text-sm rounded-xl p-3 border border-white/10 focus:outline-none focus:border-indigo-500 resize-none" rows="4" placeholder="Type your answer here..."></textarea>
            <div class="flex justify-end mt-3">
                <button id="type-send-btn" class="bg-indigo-600 hover:bg-indigo-500 text-white text-xs font-semibold px-5 py-2 rounded-lg transition-colors flex items-center gap-1.5">
                    <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M6 12 3.269 3.125A59.769 59.769 0 0 1 21.485 12 59.768 59.768 0 0 1 3.27 20.875L5.999 12Zm0 0h7.5"/>
                    </svg>
                    Send
                </button>
            </div>
        </div>
    </div>


    <!-- ================================================================
         SCRIPTS
         ================================================================ -->
    <script src="https://cdn.jsdelivr.net/npm/monaco-editor@0.45.0/min/vs/loader.js"></script>
    <script src="{{ url_for('static', filename='js/interview-room.js') }}"></script>
    <script>
    document.addEventListener('DOMContentLoaded', function() {
        window.interviewRoom = new InterviewRoom({
            sessionId: {{ iv_session.id }},
            duration: {{ iv_session.duration_minutes }},
            interviewType: '{{ iv_session.interview_type }}',
            persona: '{{ iv_session.persona }}',
            difficulty: '{{ iv_session.difficulty }}',
            targetRole: '{{ iv_session.target_role|e }}',
            userName: '{{ (user.first_name or "You")|e }}',
        });

        /* type-modal close button (not handled by InterviewRoom) */
        document.getElementById('type-modal-close')?.addEventListener('click', function() {
            document.getElementById('type-modal')?.classList.add('hidden');
        });
    });
    </script>
</body>
</html>
