{% extends "dashboard_base.html" %}
{% block title %}Interview Session â€” LevelUpX{% endblock %}
{% block page_title %}{{ iv_session.target_role }} Interview{% endblock %}
{% block content %}

<div id="interview-app" class="max-w-6xl mx-auto"
     data-session-id="{{ iv_session.id }}"
     data-duration="{{ iv_session.duration_minutes }}"
     data-interview-type="{{ iv_session.interview_type }}"
     data-persona="{{ iv_session.persona }}">

    <!-- Top Status Bar -->
    <div class="bg-white rounded-2xl shadow-sm border border-slate-200 p-3 mb-4 flex items-center gap-4 flex-wrap">
        <!-- Timer -->
        <div id="timer-display" class="flex items-center gap-2 bg-slate-50 px-4 py-2 rounded-xl">
            <svg class="w-4 h-4 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
            <span id="timer-text" class="text-sm font-bold text-slate-700 tabular-nums">{{ iv_session.duration_minutes }}:00</span>
        </div>
        <!-- Question counter -->
        <div id="question-counter" class="flex items-center gap-2 bg-slate-50 px-4 py-2 rounded-xl">
            <svg class="w-4 h-4 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
            <span id="q-counter-text" class="text-sm font-bold text-slate-700">Q1</span>
        </div>
        <!-- Interview info -->
        <div class="flex items-center gap-2 text-xs text-slate-400">
            <span class="bg-brand-50 text-brand-700 px-2 py-0.5 rounded-full font-semibold">{{ iv_session.interview_type|capitalize }}</span>
            <span class="bg-slate-100 text-slate-600 px-2 py-0.5 rounded-full font-semibold">{{ iv_session.difficulty|capitalize }}</span>
        </div>
        <div class="flex-1"></div>
        <!-- End Interview -->
        <button id="end-btn" onclick="interviewEngine.endInterview()"
                class="px-4 py-2 bg-red-50 hover:bg-red-100 text-red-600 font-semibold text-xs rounded-xl transition flex items-center gap-1.5">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 10a1 1 0 011-1h4a1 1 0 011 1v4a1 1 0 01-1 1h-4a1 1 0 01-1-1v-4z"/></svg>
            End Interview
        </button>
    </div>

    <!-- Main interview area -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">

        <!-- Left: Avatar + Controls (1 col on lg) -->
        <div class="lg:col-span-1 space-y-4">
            <!-- Avatar Card -->
            <div class="bg-white rounded-2xl shadow-sm border border-slate-200 p-5 text-center">
                <!-- Avatar image -->
                <div id="avatar-container" class="relative inline-block mb-3">
                    <div class="w-28 h-28 rounded-full bg-gradient-to-br from-brand-500 to-indigo-600 flex items-center justify-center text-white text-4xl font-bold mx-auto overflow-hidden"
                         style="animation: breathe 4s ease-in-out infinite;">
                        <svg class="w-14 h-14" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/></svg>
                    </div>
                    <!-- Speaking indicator overlay -->
                    <div id="speaking-indicator" class="hidden absolute -bottom-1 left-1/2 -translate-x-1/2 flex items-end gap-0.5 h-4">
                        <div class="w-1 bg-emerald-500 rounded-full animate-eq-1"></div>
                        <div class="w-1 bg-emerald-500 rounded-full animate-eq-2"></div>
                        <div class="w-1 bg-emerald-500 rounded-full animate-eq-3"></div>
                        <div class="w-1 bg-emerald-500 rounded-full animate-eq-4"></div>
                        <div class="w-1 bg-emerald-500 rounded-full animate-eq-3"></div>
                    </div>
                </div>
                <p class="text-sm font-bold text-slate-800">Alex</p>
                <p class="text-[10px] text-slate-400 mt-0.5">{{ iv_session.persona|capitalize }} Interviewer</p>

                <!-- Status text -->
                <div id="ai-status" class="mt-3 px-3 py-1.5 bg-slate-50 rounded-lg">
                    <p id="ai-status-text" class="text-xs text-slate-500">Starting interview...</p>
                </div>
            </div>

            <!-- Mic Controls -->
            <div class="bg-white rounded-2xl shadow-sm border border-slate-200 p-5 text-center space-y-3">
                <button id="mic-btn" onclick="interviewEngine.toggleMic()"
                        class="w-16 h-16 rounded-full bg-brand-500 hover:bg-brand-600 text-white mx-auto flex items-center justify-center transition-all shadow-lg shadow-brand-500/30">
                    <svg id="mic-icon" class="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z"/>
                    </svg>
                </button>
                <p id="mic-status" class="text-xs text-slate-400">Click to speak</p>

                <!-- Text fallback -->
                <div class="border-t border-slate-100 pt-3">
                    <p class="text-[10px] text-slate-300 mb-2">Or type your answer</p>
                    <div class="flex gap-2">
                        <input type="text" id="text-input" placeholder="Type here..."
                               class="flex-1 px-3 py-2 border border-slate-200 rounded-lg text-xs focus:ring-1 focus:ring-brand-500 focus:border-brand-500"
                               onkeydown="if(event.key==='Enter') interviewEngine.submitTextAnswer()">
                        <button onclick="interviewEngine.submitTextAnswer()"
                                class="px-3 py-2 bg-brand-500 text-white rounded-lg text-xs font-semibold hover:bg-brand-600 transition">
                            Send
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Right: Transcript + Code Editor (2 cols on lg) -->
        <div class="lg:col-span-2 space-y-4">

            <!-- Transcript -->
            <div class="bg-white rounded-2xl shadow-sm border border-slate-200 flex flex-col" style="height: 450px;">
                <div class="px-4 py-3 border-b border-slate-100 flex items-center gap-2">
                    <svg class="w-4 h-4 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z"/></svg>
                    <span class="text-xs font-semibold text-slate-600">Interview Transcript</span>
                </div>
                <div id="transcript" class="flex-1 overflow-y-auto p-4 space-y-3">
                    <!-- Messages will be appended here by JS -->
                </div>
            </div>

            <!-- Code Editor (hidden until requires_code) -->
            <div id="code-editor-panel" class="hidden bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden">
                <div class="px-4 py-3 border-b border-slate-100 flex items-center gap-3">
                    <svg class="w-4 h-4 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 20l4-16m4 4l4 4-4 4M6 16l-4-4 4-4"/></svg>
                    <span class="text-xs font-semibold text-slate-600">Code Editor</span>
                    <select id="code-language" class="ml-auto text-xs border border-slate-200 rounded-lg px-2 py-1 focus:ring-1 focus:ring-brand-500">
                        <option value="python">Python</option>
                        <option value="javascript">JavaScript</option>
                        <option value="java">Java</option>
                        <option value="cpp">C++</option>
                        <option value="go">Go</option>
                    </select>
                    <button id="submit-code-btn" onclick="interviewEngine.submitCode()"
                            class="px-3 py-1.5 bg-emerald-500 hover:bg-emerald-600 text-white text-xs font-semibold rounded-lg transition flex items-center gap-1">
                        <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z"/></svg>
                        Submit Code
                    </button>
                </div>
                <div id="monaco-container" style="height: 300px;"></div>
            </div>
        </div>
    </div>
</div>

<!-- Custom animations -->
<style>
@keyframes breathe {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.02); }
}
@keyframes eq1 { 0%,100% { height: 4px; } 50% { height: 16px; } }
@keyframes eq2 { 0%,100% { height: 8px; } 50% { height: 12px; } }
@keyframes eq3 { 0%,100% { height: 12px; } 50% { height: 6px; } }
@keyframes eq4 { 0%,100% { height: 6px; } 50% { height: 14px; } }
.animate-eq-1 { animation: eq1 0.8s ease-in-out infinite; }
.animate-eq-2 { animation: eq2 0.6s ease-in-out infinite 0.1s; }
.animate-eq-3 { animation: eq3 0.7s ease-in-out infinite 0.2s; }
.animate-eq-4 { animation: eq4 0.5s ease-in-out infinite 0.15s; }
#mic-btn.recording { background: #ef4444; animation: pulse-ring 1.5s ease-out infinite; }
@keyframes pulse-ring {
    0% { box-shadow: 0 0 0 0 rgba(239,68,68,0.4); }
    70% { box-shadow: 0 0 0 15px rgba(239,68,68,0); }
    100% { box-shadow: 0 0 0 0 rgba(239,68,68,0); }
}
.typing-dots span {
    display: inline-block; width: 6px; height: 6px; border-radius: 50%;
    background: #94a3b8; animation: typing 1.2s ease-in-out infinite;
}
.typing-dots span:nth-child(2) { animation-delay: 0.2s; }
.typing-dots span:nth-child(3) { animation-delay: 0.4s; }
@keyframes typing { 0%,80%,100% { transform: translateY(0); } 40% { transform: translateY(-6px); } }
</style>

<!-- Monaco Editor CDN -->
<script src="https://cdn.jsdelivr.net/npm/monaco-editor@0.45.0/min/vs/loader.js"></script>
<script src="{{ url_for('static', filename='js/interview.js') }}"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    window.interviewEngine = new InterviewEngine();
});
</script>

{% endblock %}
